<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C-ã‚¨ãƒ‡ã‚£ã‚¿</title>
<link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16.png">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho&family=Noto+Sans+JP&family=Zen+Old+Mincho&family=M+PLUS+Rounded+1c&family=Yuji+Syuku&display=swap" rel="stylesheet">

<style>
    :root {
        --bg-color: #f3f4f6; --panel-bg: #ffffff; --border-color: #e5e7eb;
        --preview-bg-color: #fdfcf0; --text-color: #1f2937; --text-muted: #6b7280;
        --header-bg: #f3f4f6; --pane-header-bg: #f9fafb;
        --col-zen-bg: #dbeafe; --col-zen-tx: #2563eb;
        --col-han-bg: #d1fae5; --col-han-tx: #059669;
        --col-mute-bg: transparent; --col-mute-tx: #d1d5db;
        --col-sym-bg: #ede9fe; --col-sym-tx: #7c3aed;
    }
    body.theme-dark {
        --bg-color: #1f2937; --panel-bg: #374151; --border-color: #4b5563;
        --preview-bg-color: #2d3748; --text-color: #f3f4f6; --text-muted: #9ca3af;
        --header-bg: #111827; --pane-header-bg: #4b5563;
        --col-zen-bg: #1e3a5f; --col-zen-tx: #93c5fd;
        --col-han-bg: #14532d; --col-han-tx: #86efac;
        --col-mute-bg: transparent; --col-mute-tx: #6b7280;
        --col-sym-bg: #4c1d95; --col-sym-tx: #c4b5fd;
    }
    body.theme-sepia {
        --bg-color: #f5f0e1; --panel-bg: #faf6eb; --border-color: #d4c4a8;
        --preview-bg-color: #fdf8e8; --text-color: #5c4b37; --text-muted: #8b7355;
        --header-bg: #ebe3d0; --pane-header-bg: #f0e8d8;
    }
    body.theme-blue {
        --bg-color: #e0f2fe; --panel-bg: #f0f9ff; --border-color: #7dd3fc;
        --preview-bg-color: #f0f9ff; --text-color: #0c4a6e; --text-muted: #0369a1;
        --header-bg: #bae6fd; --pane-header-bg: #e0f2fe;
    }
    body.theme-green {
        --bg-color: #dcfce7; --panel-bg: #f0fdf4; --border-color: #86efac;
        --preview-bg-color: #f0fdf4; --text-color: #14532d; --text-muted: #166534;
        --header-bg: #bbf7d0; --pane-header-bg: #dcfce7;
    }
    * { box-sizing: border-box; }
    body {
        margin: 0; padding: 0; font-family: "Helvetica Neue", Arial, sans-serif;
        background: var(--bg-color); color: var(--text-color);
        height: 100vh; overflow: hidden; display: flex; flex-direction: column;
    }
    body.scroll-mode { height: auto; overflow-y: auto; display: block; }
    body.focus-mode header, body.focus-mode .controls-wrapper, body.focus-mode .pane-header,
    body.focus-mode .pane-subheader, body.focus-mode .pane-footer, body.focus-mode #outline-panel { display: none !important; }
    body.focus-mode .main-container { padding: 0; }
    body.focus-mode .pane { border-radius: 0; border: none; }
    .focus-exit-hint {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.7); color: white; padding: 8px 16px;
        border-radius: 20px; font-size: 0.8rem; z-index: 9999; display: none;
    }
    body.focus-mode .focus-exit-hint { display: block; }

    header {
        background: var(--header-bg); padding: 8px 10px;
        display: flex; justify-content: space-between; align-items: center;
        flex-shrink: 0; min-height: 46px; border-bottom: 1px solid var(--border-color);
        z-index: 100; flex-wrap: wrap; gap: 4px;
    }
    body.scroll-mode header { position: sticky; top: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h1 { margin: 0; font-size: 1.0rem; color: var(--text-color); margin-right: 15px; }
    .header-left, .header-right { display: flex; align-items: center; flex-wrap: wrap; gap: 4px; }

    .btn {
        background: var(--panel-bg); border: 1px solid var(--border-color); padding: 4px 10px;
        cursor: pointer; border-radius: 4px; font-size: 0.8rem; color: var(--text-color);
        transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px;
        height: 28px; white-space: nowrap;
    }
    .btn:hover { background: var(--pane-header-bg); border-color: #9ca3af; }
    .btn.active { background: #e5e7eb; font-weight: bold; border-color: #6b7280; }
    body.theme-dark .btn.active { background: #4b5563; }
    .btn-update { background: #e0f2fe; color: #0369a1; border-color: #7dd3fc; font-weight: bold; }
    .btn-update:hover { background: #bae6fd; }
    .btn-sync { background: #fef9c3; color: #854d0e; border-color: #fde047; font-weight: bold; }
    .btn-sync:hover { background: #fef08a; }
    .btn-save { background: #2563eb; color: white; border: 1px solid #1d4ed8; }
    .btn-save:hover { background: #1d4ed8; color: white; }
    .btn-undo { background: #f3e8ff; color: #7c3aed; border-color: #d8b4fe; }
    .btn-undo:hover { background: #ede9fe; }
    .btn-apply { background: #dcfce7; color: #166534; border-color: #86efac; font-size: 0.7rem; padding: 2px 6px; height: 22px; }
    .btn-apply:hover { background: #bbf7d0; }
    .btn-apply-all { background: #fef3c7; color: #92400e; border-color: #fcd34d; font-weight: bold; }
    .btn-apply-all:hover { background: #fde68a; }
    .btn-focus { background: #fce7f3; color: #be185d; border-color: #f9a8d4; }
    .btn-focus:hover { background: #fbcfe8; }
    .btn-focus.active { background: #be185d; color: white; }
    .btn-analysis { background: #dbeafe; color: #1d4ed8; border-color: #93c5fd; font-weight: bold; }
    .btn-analysis:hover { background: #bfdbfe; }
    .btn-export { background: #fef3c7; color: #92400e; border-color: #fcd34d; font-size: 0.7rem; padding: 2px 6px; }
    .btn-import { background: #e0e7ff; color: #3730a3; border-color: #a5b4fc; font-size: 0.7rem; padding: 2px 6px; }
    #file-input, #settings-file-input { display: none; }

    .dropdown { position: relative; display: inline-block; }
    .dropdown-btn { background: #fef3c7; color: #92400e; border-color: #fcd34d; }
    .dropdown-content {
        display: none; position: absolute; top: 100%; left: 0;
        background: var(--panel-bg); border: 1px solid var(--border-color);
        border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 300; min-width: 160px;
    }
    .dropdown-content.show { display: block; }
    .dropdown-content button {
        display: block; width: 100%; padding: 8px 12px; border: none;
        background: transparent; text-align: left; cursor: pointer;
        font-size: 0.85rem; color: var(--text-color);
    }
    .dropdown-content button:hover { background: #e0f2fe; }
    .dropdown-content a {
        display: block; width: 100%; padding: 8px 12px; border: none;
        background: transparent; text-align: left; cursor: pointer;
        font-size: 0.85rem; color: var(--text-color); text-decoration: none;
    }
    .dropdown-content a:hover { background: #e0f2fe; }
    .sync-dropdown:hover .sync-dropdown-content { display: block; }

    .controls-wrapper { padding: 10px 10px 0 10px; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
    .control-panel {
        background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px;
        padding: 8px 12px; font-size: 0.85rem; display: none;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;
    }
    .control-panel.open { display: flex; animation: slideDown 0.2s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    .panel-close-btn {
        position: absolute; top: 4px; right: 8px; background: transparent; border: none;
        color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 2px 6px; line-height: 1;
    }
    .panel-close-btn:hover { color: #dc2626; }
    .panel-pin-btn {
        position: absolute; top: 4px; right: 28px; background: transparent; border: none;
        color: var(--text-muted); cursor: pointer; font-size: 0.85rem; padding: 2px 6px; line-height: 1; opacity: 0.6;
    }
    .panel-pin-btn:hover { opacity: 1; }
    .panel-pin-btn.pinned { color: #dc2626; opacity: 1; }

    #search-bar { flex-wrap: wrap; gap: 8px; align-items: center; background: #f0fdf4; border-color: #bbf7d0; padding-right: 30px; }
    body.theme-dark #search-bar { background: #14532d; border-color: #166534; }
    #search-bar input { padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.8rem; }
    #search-match-info { font-weight: bold; color: #15803d; min-width: 60px; text-align: center; }
    .btn-search-exec { background: #dcfce7; color: #166534; border-color: #86efac; font-weight: bold; }

    #help-bar { background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; line-height: 1.8; flex-direction: column; padding-right: 30px; }
    #help-bar.open { display: flex; }
    body.theme-dark #help-bar { background: #451a03; border-color: #854d0e; color: #fcd34d; }
    .help-section { margin-bottom: 12px; }
    .help-section:last-child { margin-bottom: 0; }
    .help-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 4px; border-bottom: 1px dashed #fcd34d; padding-bottom: 2px; }

    #settings-bar { margin-bottom: 0; flex-wrap: wrap; gap: 12px; font-size: 0.8rem; padding: 8px 10px; padding-right: 30px; }
    .setting-group { display: flex; flex-direction: column; gap: 4px; border-right: 1px solid var(--border-color); padding-right: 12px; }
    .setting-group:last-child { border-right: none; }
    .setting-title { font-weight: bold; color: var(--text-muted); margin-bottom: 2px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; }
    .setting-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    input[type="number"] { width: 50px; }

    .main-container { display: flex; flex: 1; gap: 10px; overflow: hidden; padding: 10px; position: relative; max-width: 100vw; box-sizing: border-box; }
    /* .main-container.reverse-row uses order property for swapping */
    body.scroll-mode .main-container { flex-direction: column; overflow-y: auto; overflow-x: hidden; height: auto; max-height: calc(100vh - 150px); }
    body.scroll-mode .main-container.reverse-col { flex-direction: column-reverse; }

    .pane {
        flex: 1 1 auto; display: flex; flex-direction: column;
        background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px;
        min-width: 80px; min-height: 0; overflow: hidden; position: relative;
    }
    #pane-input { order: 1; }
    #pane-preview { order: 3; }
    .pane-resizer { order: 2; }
    .main-container.reverse-row #pane-input { order: 3; }
    .main-container.reverse-row #pane-preview { order: 1; }
    .pane.hidden { display: none !important; }
    body.scroll-mode .pane { flex: none; margin-bottom: 15px; height: 45vh; min-height: 200px; }
    body.scroll-mode #pane-input { height: 50vh; }
    body.scroll-mode #pane-preview { height: 40vh; overflow: hidden; }

    /* Pane Resizer */
    .pane-resizer {
        width: 3px; background: var(--border-color); cursor: col-resize;
        position: relative; flex-shrink: 0; z-index: 10;
        margin: 0 -3px; padding: 0 3px; /* å®Ÿéš›ã®æ“ä½œé ˜åŸŸã¯9px */
        background-clip: content-box;
    }
    .pane-resizer:hover, .pane-resizer.resizing { background: #3b82f6; background-clip: content-box; }
    body.scroll-mode .pane-resizer { display: none; }

    .pane-header {
        background: var(--pane-header-bg); padding: 0 10px; color: var(--text-muted); height: 28px;
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 1px solid var(--border-color); flex-shrink: 0;
    }
    .pane-header h2 { margin: 0; font-size: 0.8rem; font-weight: bold; }

    /* Input Tabs */
    .input-tabs-container {
        display: flex; align-items: center; background: var(--pane-header-bg);
        border-bottom: 1px solid var(--border-color); overflow-x: auto;
        flex-shrink: 0; min-height: 32px;
    }
    .input-tabs-container::-webkit-scrollbar { height: 3px; }
    .input-tabs-container::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
    .input-tab {
        padding: 6px 12px; font-size: 0.75rem; cursor: pointer; border: none;
        background: transparent; color: var(--text-muted); white-space: nowrap;
        border-right: 1px solid var(--border-color); display: flex; align-items: center; gap: 6px;
        transition: all 0.2s;
    }
    .input-tab:hover { background: var(--panel-bg); }
    .input-tab.active { background: var(--panel-bg); color: var(--text-color); font-weight: bold; border-bottom: 2px solid #2563eb; }
    .input-tab .tab-close {
        font-size: 0.7rem; color: var(--text-muted); cursor: pointer;
        padding: 0 2px; border-radius: 2px; line-height: 1;
    }
    .input-tab .tab-close:hover { background: #fee2e2; color: #dc2626; }
    .input-tab-add {
        padding: 4px 10px; font-size: 1rem; cursor: pointer; border: none;
        background: transparent; color: var(--text-muted); line-height: 1;
    }
    .input-tab-add:hover { color: #2563eb; background: #e0f2fe; }
    .tab-name-input {
        font-size: 0.75rem; padding: 2px 4px; border: 1px solid #2563eb;
        border-radius: 2px; width: 80px; background: var(--panel-bg);
    }
    .pane-close-btn {
        background: transparent; border: none; color: var(--text-muted); cursor: pointer;
        font-size: 1rem; padding: 0 4px; line-height: 1;
    }
    .pane-close-btn:hover { color: #dc2626; }
    .pane-subheader {
        background: #f0f9ff; color: #0369a1; font-size: 0.75rem; padding: 2px 10px;
        border-bottom: 1px solid #e0f2fe; text-align: right; font-family: monospace; flex-shrink: 0;
    }
    body.theme-dark .pane-subheader { background: #1e3a5f; color: #93c5fd; border-color: #1e40af; }
    .pane-body { flex: 1; overflow: hidden; position: relative; min-height: 0; }
    #pane-preview .pane-body { background-color: var(--preview-bg-color); }
    .pane-footer {
        padding: 0 8px; font-size: 0.7rem; color: var(--text-muted);
        text-align: right; border-top: 1px solid var(--border-color); background: var(--panel-bg);
        display: flex; justify-content: flex-end; align-items: center; gap: 10px; min-height: 24px;
        flex-wrap: wrap; flex-shrink: 0;
    }
    .net-count { font-weight: bold; color: var(--text-color); background: var(--pane-header-bg); padding: 0 4px; border-radius: 3px; }
    .timestamp { font-family: monospace; color: #059669; }
    .goal-display { font-weight: bold; }
    .goal-0-24 { color: #1f2937; } .goal-25-49 { color: #16a34a; } .goal-50-74 { color: #2563eb; }
    .goal-75-99 { color: #ec4899; } .goal-100 { color: #06b6d4; }
    body.theme-dark .goal-0-24 { color: #f3f4f6; }
    .today-goal { font-weight: bold; color: #f97316; }
    .today-goal.achieved { color: #10b981; }
    .writing-time { color: #8b5cf6; font-weight: bold; }

    .selection-overlay {
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
        background: rgba(37, 99, 235, 0.9); color: white; padding: 6px 16px;
        border-radius: 20px; font-size: 0.85rem; font-weight: bold; z-index: 50;
        pointer-events: none; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .selection-overlay.show { display: block; }

    /* Quick Insert Popup */
    .quick-insert-popup {
        position: fixed; display: none; z-index: 1000;
        background: var(--panel-bg); border: 1px solid var(--border-color);
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 4px; gap: 2px;
    }
    .quick-insert-popup.show { display: flex; }
    .quick-insert-popup button {
        padding: 6px 12px; border: none; background: transparent;
        cursor: pointer; font-size: 0.8rem; border-radius: 4px;
        color: var(--text-color); white-space: nowrap;
    }
    .quick-insert-popup button:hover { background: #e0f2fe; }
    .quick-insert-popup .qip-ruby { color: #dc2626; }
    .quick-insert-popup .qip-bouten { color: #7c3aed; }

    textarea {
        width: 100%; height: 100%; border: none; outline: none; resize: none;
        padding: 20px; background: transparent; font-family: inherit; line-height: inherit; font-size: inherit;
        white-space: pre-wrap; word-wrap: break-word; z-index: 2; position: relative; color: var(--text-color);
        overflow-x: hidden; overflow-y: auto;
    }
    textarea::selection { background-color: #bae6fd; color: #000; }
    .vertical-mode textarea { overflow-x: auto; overflow-y: hidden; }
    #input-mirror-container {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        visibility: hidden; pointer-events: none;
        white-space: pre-wrap; word-wrap: break-word; overflow: hidden; padding: 20px;
    }
    .vertical-mode textarea, .vertical-mode #input-mirror-container { writing-mode: vertical-rl; text-orientation: upright; }

    #preview-scroll { width: 100%; height: 100%; padding: 20px; scroll-behavior: smooth; overflow-x: hidden; overflow-y: auto; box-sizing: border-box; }
    #preview-scroll.vertical-mode { overflow-x: auto !important; overflow-y: hidden !important; height: 100%; width: 100%; }
    #preview-scroll.vertical-mode #preview-content { writing-mode: vertical-rl; text-orientation: upright; min-height: 100%; width: max-content; }
    #preview-content { word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; color: var(--text-color); max-width: 100%; }
    body.scroll-mode #preview-scroll { height: 100%; overflow-y: auto; }
    body.scroll-mode #preview-scroll.vertical-mode { overflow-x: auto !important; }
    #pane-preview .pane-body { overflow: auto; }

    /* Preview Tabs */
    .preview-tabs-container {
        display: flex; align-items: center; background: var(--pane-header-bg);
        border-bottom: 1px solid var(--border-color); overflow-x: auto;
        flex-shrink: 0; min-height: 32px;
    }
    .preview-tabs-container::-webkit-scrollbar { height: 3px; }
    .preview-tabs-container::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
    .preview-tab {
        padding: 6px 12px; font-size: 0.75rem; cursor: pointer; border: none;
        background: transparent; color: var(--text-muted); white-space: nowrap;
        border-right: 1px solid var(--border-color); transition: all 0.2s;
    }
    .preview-tab:hover { background: var(--panel-bg); }
    .preview-tab.active { background: var(--panel-bg); color: var(--text-color); font-weight: bold; border-bottom: 2px solid #16a34a; }

    ruby { ruby-align: space-between; ruby-position: over; }
    rt { color: #555; user-select: none; font-size: 0.5em; }
    body.theme-dark rt { color: #aaa; }
    .bouten-ruby rt { font-size: 0.8em; font-weight: bold; color: #333; transform: translateY(10%); }
    body.theme-dark .bouten-ruby rt { color: #eee; }
    .space-zen, .space-han { display: inline-block; font-family: monospace; color: var(--col-mute-tx); background-color: var(--col-mute-bg); }
    .space-han { min-width: 0.3em; text-align: center; }
    .highlight-active .space-zen { background-color: var(--col-zen-bg); color: var(--col-zen-tx); }
    .highlight-active .space-han { background-color: var(--col-han-bg); color: var(--col-han-tx); }
    .symbol-hl { background-color: var(--col-sym-bg); color: var(--col-sym-tx); font-weight: bold; }
    .bracket-blue { color: #2563eb; font-weight: bold; }
    .bracket-green { color: #059669; font-weight: bold; }
    .underline-text { text-decoration: underline; text-decoration-color: #dc2626; text-underline-offset: 2px; }
    .highlight-text { background: linear-gradient(transparent 60%, #fef08a 60%); }
    body.theme-dark .highlight-text { background: linear-gradient(transparent 60%, #854d0e 60%); }

    /* Memo Panel */
    #memo-panel {
        position: fixed; top: 46px; left: 0; bottom: 0; width: 280px;
        background: #fefce8; border-right: 1px solid #fcd34d;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        z-index: 200; transform: translateX(-100%); transition: transform 0.3s ease;
        display: flex; flex-direction: column;
    }
    body.theme-dark #memo-panel { background: #422006; border-color: #854d0e; }
    #memo-panel.open { transform: translateX(0); }
    .main-container.memo-docked #memo-panel {
        position: relative; top: auto; left: auto; bottom: auto;
        transform: none; box-shadow: none; z-index: 1; display: none;
        flex: 0 0 auto; resize: horizontal; overflow: auto;
        min-width: 180px; max-width: 50vw; width: 250px;
        border-right: 1px solid #fcd34d; border-left: none;
        order: -10; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å·¦å´ */
    }
    .main-container.memo-docked #memo-panel.open { display: flex; }
    .main-container.memo-docked.memo-right #memo-panel { order: 10; border-right: none; border-left: 1px solid #fcd34d; }
    .memo-header {
        padding: 8px 10px; background: #fef3c7; border-bottom: 1px solid #fcd34d;
        font-weight: bold; display: flex; justify-content: space-between; align-items: center;
    }
    body.theme-dark .memo-header { background: #713f12; border-color: #854d0e; }
    .memo-controls { display: flex; align-items: center; gap: 8px; }
    .memo-toolbar {
        display: flex; justify-content: space-between; align-items: center;
        padding: 4px 8px; background: #fef3c7; border-bottom: 1px solid #fcd34d;
        gap: 4px;
    }
    body.theme-dark .memo-toolbar { background: #713f12; border-color: #854d0e; }
    .memo-tabs { display: flex; gap: 2px; flex: 1; overflow-x: auto; }
    .memo-tab {
        padding: 2px 8px; font-size: 0.75rem; background: #fef9c3; border: 1px solid #fcd34d;
        border-radius: 4px 4px 0 0; cursor: pointer; white-space: nowrap;
    }
    .memo-tab.active { background: #fefce8; border-bottom-color: #fefce8; }
    .memo-tab-add { background: transparent; border: 1px dashed #fcd34d; color: #92400e; }
    .memo-file-btns { display: flex; gap: 2px; }
    #memo-area {
        flex: 1; width: 100%; padding: 12px; border: none; resize: none;
        font-size: 0.9rem; line-height: 1.6; background: transparent;
        font-family: inherit; color: var(--text-color); box-sizing: border-box;
    }
    #memo-area:focus { outline: none; }
    .memo-footer {
        padding: 4px 10px; background: #fef3c7; border-top: 1px solid #fcd34d;
        text-align: right;
    }
    body.theme-dark .memo-footer { background: #713f12; border-color: #854d0e; }
    body.focus-mode #memo-panel { display: none !important; }

    #outline-panel {
        position: fixed; top: 46px; right: 0; bottom: 0; width: 300px;
        background: var(--panel-bg); border-left: 1px solid var(--border-color);
        box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        z-index: 200; transform: translateX(100%); transition: transform 0.3s ease;
        display: flex; flex-direction: column;
    }
    #outline-panel.open { transform: translateX(0); }
    .main-container.outline-docked #outline-panel {
        position: relative; top: auto; right: auto; bottom: auto;
        transform: none; box-shadow: none; z-index: 1; display: none;
        flex: 0 0 auto; resize: horizontal; overflow: auto;
        min-width: 180px; max-width: 60vw; width: 300px;
        border-left: 1px solid var(--border-color); border-right: none;
        order: 10; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å³å´ */
    }
    .main-container.outline-docked #outline-panel.open { display: flex; }
    .main-container.outline-docked.outline-left #outline-panel { order: -10; border-left: none; border-right: 1px solid var(--border-color); }

    .outline-header {
        padding: 8px 10px; background: var(--pane-header-bg); border-bottom: 1px solid var(--border-color);
        font-weight: bold; display: flex; justify-content: space-between; align-items: center;
        font-size: 0.85rem; flex-wrap: wrap; gap: 4px;
    }
    .outline-controls { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .outline-tabs { display: flex; border-bottom: 1px solid var(--border-color); }
    .outline-tab {
        flex: 1; padding: 8px; text-align: center; cursor: pointer;
        background: var(--pane-header-bg); border: none; font-size: 0.8rem;
        color: var(--text-muted); transition: all 0.2s;
    }
    .outline-tab:hover { background: var(--panel-bg); }
    .outline-tab.active { background: var(--panel-bg); color: var(--text-color); font-weight: bold; border-bottom: 2px solid #2563eb; }
    .outline-content { flex: 1; overflow-y: auto; padding: 10px; }
    .outline-tab-content { display: none; }
    .outline-tab-content.active { display: block; }
    .outline-item {
        padding: 6px 8px; border-bottom: 1px solid var(--border-color); cursor: pointer;
        color: var(--text-color); font-size: 0.85rem; display: flex; align-items: center;
    }
    .outline-item:hover { background: #e0f2fe; color: #0284c7; }
    body.theme-dark .outline-item:hover { background: #1e3a5f; }
    .outline-level-1 { font-weight: bold; background: var(--pane-header-bg); border-left: 4px solid #6b7280; }
    .outline-level-2 { padding-left: 20px; border-left: 3px solid #9ca3af; }
    .outline-level-3 { padding-left: 35px; border-left: 2px solid #d1d5db; font-size: 0.8rem; }
    .outline-toggle { cursor: pointer; margin-right: 6px; font-size: 0.7rem; width: 14px; text-align: center; color: var(--text-muted); flex-shrink: 0; }
    .outline-toggle:hover { color: #2563eb; }
    .outline-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .outline-char-count { margin-left: auto; font-size: 0.7rem; color: var(--text-muted); background: var(--pane-header-bg); padding: 1px 6px; border-radius: 10px; flex-shrink: 0; }
    .outline-empty { color: var(--text-muted); font-style: italic; }
    .outline-hidden { display: none !important; }
    .outline-summary { padding: 8px 10px; background: #f0f9ff; border-top: 1px solid var(--border-color); font-size: 0.75rem; color: #0369a1; }
    body.theme-dark .outline-summary { background: #1e3a5f; color: #93c5fd; }

    .bookmark-item { padding: 8px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
    .bookmark-item:hover { background: #fef3c7; }
    .bookmark-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .bookmark-delete { color: #dc2626; cursor: pointer; font-size: 0.8rem; }
    .bookmark-delete:hover { color: #b91c1c; }
    .bookmark-add-btn { width: 100%; padding: 8px; background: #fef3c7; border: 1px dashed #fcd34d; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-bottom: 10px; }
    .bookmark-add-btn:hover { background: #fde68a; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: none; justify-content: center; align-items: center;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
        background: var(--panel-bg); border-radius: 8px; padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 600px; width: 90%;
        max-height: 80vh; overflow-y: auto; color: var(--text-color);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .modal-header h3 { margin: 0; font-size: 1.2rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
    .modal-close:hover { color: #dc2626; }
    .analysis-section { margin-bottom: 20px; padding: 15px; background: var(--pane-header-bg); border-radius: 6px; }
    .analysis-section h4 { margin: 0 0 10px 0; font-size: 0.95rem; color: #2563eb; }
    .analysis-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dotted var(--border-color); }
    .analysis-row:last-child { border-bottom: none; }
    .analysis-bar { height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin: 5px 0; }
    .analysis-bar-fill { height: 100%; border-radius: 10px; transition: width 0.3s; }
    .freq-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .freq-item { background: #dbeafe; color: #1d4ed8; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; }
    .warning-text { color: #dc2626; font-size: 0.85rem; margin-top: 8px; }

    /* Heatmap styles */
    .heatmap-container { margin: 10px 0; }
    .heatmap-title { font-size: 0.85rem; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    .heatmap-legend { font-size: 0.7rem; color: #666; }
    .heatmap-grid { display: flex; flex-wrap: wrap; gap: 2px; }
    .heatmap-cell { width: 20px; height: 20px; border-radius: 3px; cursor: pointer; position: relative; transition: transform 0.1s; }
    .heatmap-cell:hover { transform: scale(1.3); z-index: 10; }
    .heatmap-cell[data-tooltip]:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 3px 6px; border-radius: 3px; font-size: 0.7rem; white-space: nowrap; z-index: 100; }
    .heatmap-tabs { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
    .heatmap-tab { padding: 5px 10px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 0.8rem; background: var(--bg-color); }
    .heatmap-tab.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }

    .jump-dialog {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: var(--panel-bg); border: 1px solid var(--border-color);
        border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 1001; display: none;
    }
    .jump-dialog.show { display: block; }
    .jump-dialog h4 { margin: 0 0 15px 0; }
    .jump-dialog input { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; margin-bottom: 10px; }
    .jump-dialog-buttons { display: flex; gap: 10px; justify-content: flex-end; }

    /* Celebration Fireworks */
    .celebration-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        pointer-events: none; z-index: 9998; overflow: hidden;
    }
    .celebration-message {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white; padding: 20px 40px; border-radius: 16px;
        font-size: 1.5rem; font-weight: bold; text-align: center;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.5);
        z-index: 9999; animation: celebrationPop 0.5s ease-out;
        display: none;
    }
    .celebration-message.show { display: block; }
    .celebration-message .emoji { font-size: 2rem; display: block; margin-bottom: 10px; }
    .celebration-message .sub { font-size: 0.9rem; font-weight: normal; margin-top: 8px; opacity: 0.9; }
    @keyframes celebrationPop {
        0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        50% { transform: translate(-50%, -50%) scale(1.1); }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    .firework {
        position: absolute; width: 6px; height: 6px; border-radius: 50%;
        animation: fireworkBurst 1.5s ease-out forwards;
    }
    @keyframes fireworkBurst {
        0% { transform: translate(0, 0) scale(1); opacity: 1; }
        100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
    }
    .firework-trail {
        position: absolute; width: 4px; height: 4px; border-radius: 50%;
        animation: fireworkTrail 0.8s ease-out forwards;
    }
    @keyframes fireworkTrail {
        0% { transform: translateY(0); opacity: 1; }
        100% { transform: translateY(var(--rise)); opacity: 0; }
    }

    .save-dialog-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 1000;
        display: flex; justify-content: center; align-items: center;
    }
    .save-dialog {
        background: var(--panel-bg); border-radius: 8px; padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3); min-width: 300px;
    }
    .save-dialog h3 { margin: 0 0 15px 0; color: var(--text-color); }
    .save-dialog-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .save-dialog-buttons button { padding: 10px 20px; font-size: 1rem; }

    @media print {
        header, .controls-wrapper, .pane-subheader, .pane-footer, #outline-panel, #pane-input, .selection-overlay { display: none !important; }
        body, body.scroll-mode { height: auto; overflow: visible; background: white; }
        .main-container { padding: 0; display: block; }
        .pane { border: none; box-shadow: none; height: auto !important; }
        #pane-preview { display: block !important; }
        #pane-preview .pane-header { display: none; }
        #pane-preview .pane-body { overflow: visible; }
        #preview-scroll { padding: 0; height: auto; overflow: visible; }
        #preview-content { font-size: 10.5pt; line-height: 1.8; }
        .vertical-mode #preview-content { writing-mode: horizontal-tb; }
    }
</style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>C-ã‚¨ãƒ‡ã‚£ã‚¿</h1>
        <button class="btn btn-undo" onclick="undoInput()" title="å…ƒã«æˆ»ã™">â†©</button>
        <button class="btn btn-undo" onclick="redoInput()" title="ã‚„ã‚Šç›´ã—">â†ª</button>
        <button class="btn" onclick="togglePanel('help-bar')">ä½¿ã„æ–¹</button>
        <button class="btn" onclick="togglePanel('search-bar')">ğŸ” æ¤œç´¢</button>
        <button class="btn" onclick="togglePanel('settings-bar')">è¨­å®š</button>
        <div class="dropdown">
            <button class="btn dropdown-btn" onclick="toggleDropdown('insert-dropdown')">ğŸ“ æŒ¿å…¥</button>
            <div id="insert-dropdown" class="dropdown-content">
                <button onclick="insertText('â€•â€•')">â€•â€• ãƒ€ãƒƒã‚·ãƒ¥</button>
                <button onclick="insertText('â€¦â€¦')">â€¦â€¦ ä¸‰ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼</button>
                <button onclick="insertText('ã€Œã€', 1)">ã€Œã€ é‰¤æ‹¬å¼§</button>
                <button onclick="insertText('ã€ã€', 1)">ã€ã€ äºŒé‡é‰¤æ‹¬å¼§</button>
                <button onclick="insertText('ï½œã€Šã€‹', 1)">ï½œã€Šã€‹ ãƒ«ãƒ“è¨˜æ³•</button>
                <button onclick="insertText('ã€Šã€Šã€‹ã€‹', 2)">ã€Šã€Šã€‹ã€‹ å‚ç‚¹è¨˜æ³•</button>
                <button onclick="insertRubyToSelection()">ğŸ”¤ é¸æŠæ–‡å­—ã«ãƒ«ãƒ“</button>
                <button onclick="insertBoutenToSelection()">âš« é¸æŠæ–‡å­—ã«å‚ç‚¹</button>
            </div>
        </div>
        <button class="btn" onclick="toggleLayoutAxis()">ç¸¦æ¨ªåˆ‡æ›¿</button>
        <button class="btn" id="btn-layout-swap" onclick="toggleLayoutOrder()">å…¥æ›¿</button>
        <button class="btn btn-update" onclick="updatePreviewAndShow()">ğŸ”„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°</button>
        <div class="dropdown sync-dropdown">
            <button class="btn btn-sync dropdown-btn">ğŸ“² åŒæœŸ â–¼</button>
            <div class="dropdown-content sync-dropdown-content">
                <a onclick="syncPreviewPosition()">å…¥åŠ› â†’ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
                <a onclick="doSyncPreviewToInput()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ å…¥åŠ›</a>
            </div>
        </div>
        <button class="btn btn-analysis" onclick="showAnalysis()">ğŸ“Š åˆ†æ</button>
        <button class="btn btn-focus" id="btn-focus" onclick="toggleFocusMode()">ğŸ§˜ é›†ä¸­</button>
    </div>
    <div class="header-right">
        <button class="btn" onclick="toggleMemoPane()">ğŸ“ ãƒ¡ãƒ¢</button>
        <button class="btn" onclick="toggleOutline()">ğŸ“‘ ç›®æ¬¡</button>
        <input type="file" id="file-input" accept=".txt" onchange="loadFile(this)">
        <button class="btn" onclick="document.getElementById('file-input').click()">ğŸ“‚ é–‹ã</button>
        <button class="btn btn-save" onclick="showSaveDialog()">ğŸ’¾ ä¿å­˜</button>
    </div>
</header>

<div class="controls-wrapper">
    <div id="search-bar" class="control-panel">
        <button class="panel-pin-btn" onclick="togglePanelPin('search-bar')" title="å›ºå®š">ğŸ“Œ</button>
        <button class="panel-close-btn" onclick="togglePanel('search-bar')">âœ•</button>
        <input type="text" id="search-input" placeholder="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰..." onkeydown="if(event.key==='Enter') findNext()">
        <button class="btn btn-search-exec" onclick="doSearch()">æ¤œç´¢</button>
        <button class="btn" onclick="findPrev()">â–² å‰ã¸</button>
        <button class="btn" onclick="findNext()">â–¼ æ¬¡ã¸</button>
        <span id="search-match-info">0 / 0</span>
        <div style="width:1px;height:20px;background:#ccc;margin:0 4px;"></div>
        <input type="text" id="replace-input" placeholder="ç½®æ›å¾Œ...">
        <button class="btn" onclick="replaceOne()">ç½®æ›</button>
        <button class="btn" onclick="replaceAll()">å…¨ç½®æ›</button>
    </div>
    
    <div id="help-bar" class="control-panel">
        <button class="panel-pin-btn" onclick="togglePanelPin('help-bar')" title="å›ºå®š">ğŸ“Œ</button>
        <button class="panel-close-btn" onclick="togglePanel('help-bar')">âœ•</button>
        <div style="display: flex; flex-wrap: wrap; gap: 16px;">
            <div class="help-section" style="flex: 1; min-width: 180px;">
                <div class="help-title">ã€åŸºæœ¬æ“ä½œã€‘</div>
                ãƒ»<b>å…¥åŠ›ã‚¨ãƒªã‚¢</b>ï¼šæ–‡ç« ã‚’å…¥åŠ›<br>
                ãƒ»<b>ğŸ”„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°</b>ï¼šæ•´å½¢è¡¨ç¤ºï¼ˆéè¡¨ç¤ºæ™‚ã¯è‡ªå‹•è¡¨ç¤ºï¼‰<br>
                ãƒ»<b>ğŸ“² åŒæœŸ</b>ï¼šã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç§»å‹•<br>
                ãƒ»<b>ç¸¦æ¨ªåˆ‡æ›¿</b>ï¼šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´<br>
                ãƒ»<b>å…¥æ›¿</b>ï¼šãƒšã‚¤ãƒ³ã®é †åºã‚’å…¥ã‚Œæ›¿ãˆ
            </div>
            <div class="help-section" style="flex: 1; min-width: 180px;">
                <div class="help-title">ã€ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã€‘</div>
                ãƒ»<b>Ctrl+S</b>ï¼šä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°<br>
                ãƒ»<b>Ctrl+F</b>ï¼šæ¤œç´¢ãƒ‘ãƒãƒ«<br>
                ãƒ»<b>Ctrl+G</b>ï¼šè¡Œç•ªå·ã‚¸ãƒ£ãƒ³ãƒ—<br>
                ãƒ»<b>Ctrl+T</b>ï¼šæ–°è¦ã‚¿ãƒ–è¿½åŠ <br>
                ãƒ»<b>Ctrl+Shift+T</b>ï¼šæ–°è¦ãƒ¡ãƒ¢ã‚¿ãƒ–<br>
                ãƒ»<b>Ctrl+Z</b>ï¼šå…ƒã«æˆ»ã™<br>
                ãƒ»<b>Ctrl+Y</b>ï¼šã‚„ã‚Šç›´ã—<br>
                ãƒ»<b>F11</b>ï¼šé›†ä¸­ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿<br>
                ãƒ»<b>Esc</b>ï¼šãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–‰ã˜ã‚‹
            </div>
            <div class="help-section" style="flex: 1; min-width: 180px;">
                <div class="help-title">ã€è¨˜æ³•ï¼ˆå°èª¬å‘ã‘ï¼‰ã€‘</div>
                ãƒ»<b>ãƒ«ãƒ“</b>ï¼šï½œæ¼¢å­—ã€Šã‹ã‚“ã˜ã€‹<br>
                ãƒ»<b>å‚ç‚¹</b>ï¼šã€Šã€Šå¼·èª¿ã€‹ã€‹<br>
                ãƒ»<b>å‚ç·š</b>ï¼š__ä¸‹ç·š__<br>
                ãƒ»<b>è›å…‰ãƒšãƒ³</b>ï¼š==å¼·èª¿==<br>
                <small>â€»ãƒ†ã‚­ã‚¹ãƒˆé¸æŠæ™‚ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ«ãƒ“ãƒ»å‚ç‚¹æŒ¿å…¥å¯èƒ½</small>
            </div>
            <div class="help-section" style="flex: 1; min-width: 180px;">
                <div class="help-title">ã€åŸ·ç­†æ”¯æ´ã€‘</div>
                ãƒ»<b>ğŸ§˜ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰</b>ï¼šUIã‚’éš ã—ã¦åŸ·ç­†ã«é›†ä¸­<br>
                ãƒ»<b>ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼</b>ï¼šã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ä¸­å¤®ã«å›ºå®š<br>
                ãƒ»<b>åŸ·ç­†æ™‚é–“ãƒˆãƒ©ãƒƒã‚«ãƒ¼</b>ï¼šè‡ªå‹•è¨ˆæ¸¬<br>
                ãƒ»<b>ğŸ“Š åˆ†æ</b>ï¼šæ–‡å­—ç¨®ãƒ»æ–‡é•·ãƒ»é »å‡ºèªã‚’åˆ†æ
            </div>
            <div class="help-section" style="flex: 1; min-width: 180px;">
                <div class="help-title">ã€ç›®æ¨™æ©Ÿèƒ½ã€‘</div>
                ãƒ»<b>å…¨ä½“ç›®æ¨™</b>ï¼šä½œå“å…¨ä½“ã®ç›®æ¨™æ–‡å­—æ•°<br>
                ãƒ»<b>ä»Šæ—¥ã®ç›®æ¨™</b>ï¼š1æ—¥ã®åŸ·ç­†ç›®æ¨™<br>
                ãƒ»ç›®æ¨™é”æˆæ™‚ã«ğŸ‰ãŠç¥ã„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º<br>
                ãƒ»é€²æ—ã«å¿œã˜ã¦è‰²ãŒå¤‰åŒ–
            </div>
            <div class="help-section" style="flex: 1; min-width: 180px;">
                <div class="help-title">ã€ç›®æ¬¡ãƒ»ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã€‘</div>
                ãƒ»<b>ğŸ“‘ ç›®æ¬¡</b>ï¼šè¦‹å‡ºã—ï¼ˆâ– â–¡â–²ãªã©ï¼‰ã‚’è‡ªå‹•æ¤œå‡º<br>
                ãƒ»<b>ğŸ”– ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</b>ï¼šä»»æ„ã®ä½ç½®ã‚’ä¿å­˜<br>
                ãƒ»ã‚¯ãƒªãƒƒã‚¯ã§ãã®ä½ç½®ã«ã‚¸ãƒ£ãƒ³ãƒ—<br>
                ãƒ»ğŸ“Œå›ºå®šã§å¸¸ã«è¡¨ç¤º
            </div>
            <div class="help-section" style="flex: 1; min-width: 180px;">
                <div class="help-title">ã€ä¿å­˜ãƒ»èª­è¾¼ã€‘</div>
                ãƒ»<b>ğŸ’¾ ä¿å­˜</b>ï¼šãƒ†ã‚­ã‚¹ãƒˆ/HTMLå½¢å¼ã§ä¿å­˜<br>
                ãƒ»<b>ğŸ“‚ é–‹ã</b>ï¼šãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­è¾¼<br>
                ãƒ»<b>è‡ªå‹•ä¿å­˜</b>ï¼š30ç§’ã”ã¨ã«ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜<br>
                ãƒ»è¨­å®šã®ğŸ“¤ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ğŸ“¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            </div>
            <div class="help-section" style="flex: 1; min-width: 180px;">
                <div class="help-title">ã€è¨­å®šã€‘</div>
                ãƒ»<b>ãƒ•ã‚©ãƒ³ãƒˆ</b>ï¼šæ˜æœãƒ»ã‚´ã‚·ãƒƒã‚¯ãƒ»ç­†æ–‡å­—ãªã©<br>
                ãƒ»<b>ç¸¦æ›¸ã/æ¨ªæ›¸ã</b>ï¼šåˆ‡æ›¿å¯èƒ½<br>
                ãƒ»<b>ãƒ†ãƒ¼ãƒ</b>ï¼šãƒ©ã‚¤ãƒˆãƒ»ãƒ€ãƒ¼ã‚¯ãƒ»ã‚»ãƒ”ã‚¢ãªã©<br>
                ãƒ»<b>åŸç¨¿ç”¨ç´™æ›ç®—</b>ï¼šæšæ•°ã‚’è‡ªå‹•è¨ˆç®—
            </div>
        </div>
    </div>

    <div id="settings-bar" class="control-panel">
        <button class="panel-pin-btn" onclick="togglePanelPin('settings-bar')" title="å›ºå®š">ğŸ“Œ</button>
        <button class="panel-close-btn" onclick="togglePanel('settings-bar')">âœ•</button>
        <div class="setting-group">
            <div class="setting-title">å…¥åŠ›ã‚¨ãƒªã‚¢ <button class="btn btn-apply" onclick="applyInputSettings()">é©ç”¨</button></div>
            <div class="setting-row">
                <label>æ–‡å­—: <input type="number" id="st-in-size" value="17" min="10" max="60"></label>
                <label>è¡Œé–“: <input type="number" id="st-in-line" value="1.7" step="0.1" min="1.0" max="5.0"></label>
                <label><input type="checkbox" id="st-in-v" checked> ç¸¦æ›¸ã</label>
            </div>
            <div class="setting-row">
                <label>ãƒ•ã‚©ãƒ³ãƒˆ: 
                    <select id="st-in-font">
                        <option value="font-gothic">ã‚´ã‚·ãƒƒã‚¯</option>
                        <option value="font-mincho" selected>æ˜æœä½“</option>
                        <option value="font-old">ã‚¢ãƒ³ãƒ†ã‚£ãƒ¼ã‚¯</option>
                        <option value="font-round">ä¸¸ã‚´ã‚·ãƒƒã‚¯</option>
                        <option value="font-brush">ç­†æ–‡å­—</option>
                    </select>
                </label>
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ <button class="btn btn-apply" onclick="applyPreviewSettings()">é©ç”¨</button></div>
            <div class="setting-row">
                <label>æ–‡å­—: <input type="number" id="st-pv-size" value="17" min="10" max="60"></label>
                <label>è¡Œé–“: <input type="number" id="st-pv-line" value="1.7" step="0.1" min="1.0" max="5.0"></label>
                <label><input type="checkbox" id="st-pv-v" checked> ç¸¦æ›¸ã</label>
            </div>
            <div class="setting-row">
                <label>ãƒ•ã‚©ãƒ³ãƒˆ: 
                    <select id="st-pv-font">
                        <option value="font-gothic">ã‚´ã‚·ãƒƒã‚¯</option>
                        <option value="font-mincho" selected>æ˜æœä½“</option>
                        <option value="font-old">ã‚¢ãƒ³ãƒ†ã‚£ãƒ¼ã‚¯</option>
                        <option value="font-round">ä¸¸ã‚´ã‚·ãƒƒã‚¯</option>
                        <option value="font-brush">ç­†æ–‡å­—</option>
                    </select>
                </label>
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-title">è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³ <button class="btn btn-apply" onclick="applyDisplaySettings()">é©ç”¨</button></div>
            <div class="setting-row">
                <label><input type="checkbox" id="st-show-space" checked> ã‚¹ãƒšãƒ¼ã‚¹å¯è¦–åŒ–</label>
                <label><input type="checkbox" id="st-show-highlight" checked> ãƒã‚¤ãƒ©ã‚¤ãƒˆ</label>
            </div>
            <div class="setting-row">
                <label><input type="checkbox" id="check-show-input" checked> å…¥åŠ›è¡¨ç¤º</label>
                <label><input type="checkbox" id="check-show-preview" checked> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º</label>
            </div>
            <div class="setting-row">
                <label><input type="checkbox" id="st-default-preview-hidden"> èµ·å‹•æ™‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éè¡¨ç¤º</label>
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-title">åŸ·ç­†æ”¯æ´ <button class="btn btn-apply" onclick="applyWritingSettings()">é©ç”¨</button></div>
            <div class="setting-row">
                <label><input type="checkbox" id="st-typewriter-mode"> ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼</label>
                <label><input type="checkbox" id="st-writing-tracker" checked> æ™‚é–“ãƒˆãƒ©ãƒƒã‚«ãƒ¼</label>
            </div>
            <div class="setting-row" id="writing-time-display" style="color: #8b5cf6; font-weight: bold;">åŸ·ç­†æ™‚é–“: 00:00:00</div>
        </div>

        <div class="setting-group">
            <div class="setting-title">ç›®æ¨™ãƒ»çµ±è¨ˆ <button class="btn btn-apply" onclick="applyGoalSettings()">é©ç”¨</button></div>
            <div class="setting-row">
                <label>å…¨ä½“ç›®æ¨™: <input type="number" id="st-goal-chars" value="150000" min="0" max="999999" style="width:70px;"> å­—</label>
            </div>
            <div class="setting-row">
                <label>ä»Šæ—¥ã®ç›®æ¨™: <input type="number" id="st-today-goal" value="2000" min="0" max="99999" style="width:60px;"> å­—</label>
                <button class="btn btn-apply" onclick="resetTodayStart()" style="font-size:0.65rem;">é–‹å§‹ç‚¹ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="setting-row">
                <label><input type="checkbox" id="st-show-reading-time" checked> èª­ã¿ä¸Šã’æ™‚é–“</label>
            </div>
            <div class="setting-row">
                <label><input type="checkbox" id="st-celebrate-goal" checked> ç›®æ¨™é”æˆæ™‚ã«ãŠç¥ã„è¡¨ç¤º</label>
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-title">åŸç¨¿ç”¨ç´™ <button class="btn btn-apply" onclick="applyManuscriptSettings()">é©ç”¨</button></div>
            <div class="setting-row">
                <label>è¡Œ: <input type="number" id="st-manuscript-rows" value="34" min="1" max="100" style="width:50px;"></label>
                <label>Ã—æ–‡å­—: <input type="number" id="st-manuscript-cols" value="42" min="1" max="100" style="width:50px;"></label>
            </div>
            <div class="setting-row">
                <label><input type="checkbox" id="st-show-manuscript" checked> æ›ç®—è¡¨ç¤º</label>
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-title">ãƒ†ãƒ¼ãƒ <button class="btn btn-apply" onclick="applyThemeSettings()">é©ç”¨</button></div>
            <div class="setting-row">
                <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ:
                    <select id="st-theme-preset">
                        <option value="">ãƒ©ã‚¤ãƒˆ</option>
                        <option value="theme-dark">ãƒ€ãƒ¼ã‚¯</option>
                        <option value="theme-sepia">ã‚»ãƒ”ã‚¢</option>
                        <option value="theme-blue">ãƒ–ãƒ«ãƒ¼</option>
                        <option value="theme-green">ã‚°ãƒªãƒ¼ãƒ³</option>
                    </select>
                </label>
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-title">ãƒšã‚¤ãƒ³å¹… <button class="btn btn-apply" onclick="applyPaneWidthSettings()">é©ç”¨</button></div>
            <div class="setting-row">
                <label>å…¥åŠ›: <input type="number" id="st-pane-input-width" value="50" min="10" max="90" style="width:50px;">%</label>
                <label>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: <input type="number" id="st-pane-preview-width" value="50" min="10" max="90" style="width:50px;">%</label>
            </div>
            <div class="setting-row">
                <button class="btn btn-apply" onclick="resetPaneWidths()" style="font-size:0.65rem;">å¹…ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>

        <div class="setting-group" style="border-right:none; margin-left:auto; display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
            <button class="btn" onclick="exportSettings()" style="font-size:0.7rem;">ğŸ“¤å‡ºåŠ›</button>
            <input type="file" id="settings-file-input" accept=".json" onchange="importSettings(this)" style="display:none;">
            <button class="btn" onclick="document.getElementById('settings-file-input').click()" style="font-size:0.7rem;">ğŸ“¥èª­è¾¼</button>
            <button class="btn" onclick="resetAllSettings()" style="font-size:0.7rem; background:#fee2e2; color:#dc2626; border-color:#fecaca;">ğŸ”„åˆæœŸåŒ–</button>
            <button class="btn btn-apply-all" onclick="applyAllSettings()">âš¡ å…¨ä½“é©ç”¨</button>
        </div>
    </div>
</div>

<div class="main-container" id="main-container">
    <div class="pane" id="pane-input">
        <div class="pane-header"><h2>å…¥åŠ›</h2><button class="pane-close-btn" onclick="hidePane('input')">âœ•</button></div>
        <div class="input-tabs-container" id="input-tabs-container">
            <!-- Tabs will be dynamically generated -->
        </div>
        <div class="pane-subheader" id="input-pos-bar">ç¾åœ¨: 1 è¡Œç›®</div>
        <div class="pane-body">
            <div id="input-mirror-container"></div>
            <textarea id="input-area" spellcheck="false"></textarea>
            <div id="input-sel-overlay" class="selection-overlay"></div>
        </div>
        <div class="pane-footer">
            <span id="char-count">å…¨ä½“: 0</span>
            <span id="input-net-count" class="net-count">å®Ÿè³ª: 0</span>
            <span id="line-count">0 è¡Œ</span>
            <span id="input-goal-display" class="goal-display"></span>
            <span id="input-today-goal" class="today-goal"></span>
            <span id="input-writing-time" class="writing-time"></span>
            <span id="input-reading-time" class="reading-time"></span>
            <span id="input-manuscript" class="manuscript-pages"></span>
        </div>
    </div>

    <div class="pane-resizer" id="resizer-input-preview"></div>

    <div class="pane" id="pane-preview">
        <div class="pane-header">
            <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <button class="pane-close-btn" onclick="hidePane('preview')">âœ•</button>
        </div>
        <div class="preview-tabs-container" id="preview-tabs-container">
            <!-- Preview tabs will be dynamically generated -->
        </div>
        <div class="pane-subheader" id="preview-pos-bar">ä½ç½®: 0%</div>
        <div class="pane-body">
            <div id="preview-scroll"><div id="preview-content"></div></div>
            <div id="preview-sel-overlay" class="selection-overlay"></div>
        </div>
        <div class="pane-footer">
            <span id="pv-time" class="timestamp">æœªæ›´æ–°</span>
            <span style="border-left:1px solid var(--border-color); height:12px; margin:0 5px;"></span>
            <span id="pv-total-count">å…¨ä½“: 0</span>
            <span id="pv-net-count" class="net-count">å®Ÿè³ª: 0</span>
            <span id="pv-line-count">0 è¡Œ</span>
            <span id="pv-goal-display" class="goal-display"></span>
            <span id="pv-today-goal" class="today-goal"></span>
            <span id="pv-reading-time" class="reading-time"></span>
            <span id="pv-manuscript" class="manuscript-pages"></span>
        </div>
    </div>

    <div id="memo-panel">
        <div class="memo-header">
            <span>ğŸ“ ãƒ¡ãƒ¢</span>
            <div class="memo-controls">
                <label style="font-size:0.75rem; font-weight:normal;"><input type="checkbox" id="check-memo-dock" onchange="toggleMemoDock()"> ğŸ“Œå›ºå®š</label>
                <button id="btn-memo-swap" class="btn" style="display:none; padding:2px 6px; font-size:0.7rem;" onclick="swapMemoSide()">å·¦å³å…¥æ›¿</button>
                <button class="btn" onclick="toggleMemoPane()" style="border:none; background:transparent;">âœ•</button>
            </div>
        </div>
        <div class="memo-toolbar">
            <div id="memo-tabs-container" class="memo-tabs"></div>
            <div class="memo-file-btns">
                <input type="file" id="memo-file-input" accept=".txt" style="display:none;" onchange="loadMemoFile(this)">
                <button class="btn" onclick="document.getElementById('memo-file-input').click()" title="ãƒ¡ãƒ¢ã‚’é–‹ã" style="padding:2px 6px; font-size:0.7rem;">ğŸ“‚</button>
                <button class="btn" onclick="showMemoSaveDialog()" title="ãƒ¡ãƒ¢ã‚’ä¿å­˜" style="padding:2px 6px; font-size:0.7rem;">ğŸ’¾</button>
            </div>
        </div>
        <textarea id="memo-area" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
        <div class="memo-footer">
            <span id="memo-char-count" style="font-size: 0.75rem; color: var(--text-muted);">0å­—</span>
        </div>
    </div>

    <div id="outline-panel">
        <div class="outline-header">
            <span>ğŸ“‘ ç›®æ¬¡</span>
            <div class="outline-controls">
                <label style="font-size:0.75rem; font-weight:normal;"><input type="checkbox" id="check-outline-dock" onchange="toggleOutlineDock()"> ğŸ“Œå›ºå®š</label>
                <button id="btn-outline-swap" class="btn" style="display:none; padding:2px 6px; font-size:0.7rem;" onclick="swapOutlineSide()">å·¦å³å…¥æ›¿</button>
                <button class="btn" onclick="toggleOutline()" style="border:none; background:transparent;">âœ•</button>
            </div>
        </div>
        <div class="outline-toolbar" style="display:flex; padding:4px 8px; background:var(--pane-header-bg); border-bottom:1px solid var(--border-color); gap:4px; align-items:center;">
            <div class="outline-tabs-inner" style="display:flex; gap:2px; flex:1;">
                <span class="memo-tab active" onclick="switchOutlineTab('outline')" style="cursor:pointer;">ç›®æ¬¡</span>
                <span class="memo-tab" onclick="switchOutlineTab('bookmark')" style="cursor:pointer;">ğŸ”–ã—ãŠã‚Š</span>
            </div>
        </div>
        <div class="outline-content">
            <div id="outline-tab-outline" class="outline-tab-content active">
                <div style="margin-bottom:8px; display:flex; gap:4px; flex-wrap:wrap;">
                    <button class="btn" style="padding:2px 6px; font-size:0.7rem;" onclick="generateOutline()">ğŸ”„æ›´æ–°</button>
                    <button class="btn" style="padding:2px 6px; font-size:0.7rem;" onclick="expandAllOutline()">å…¨å±•é–‹</button>
                    <button class="btn" style="padding:2px 6px; font-size:0.7rem;" onclick="collapseAllOutline()">å…¨æŠ˜ç•³</button>
                </div>
                <div id="outline-list"></div>
            </div>
            <div id="outline-tab-bookmark" class="outline-tab-content">
                <button class="bookmark-add-btn" onclick="addBookmark()">ï¼‹ ç¾åœ¨ä½ç½®ã«ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’è¿½åŠ </button>
                <div id="bookmark-actions" style="display:none; margin-bottom: 8px; padding: 4px; background: #fef3c7; border-radius: 4px;">
                    <label style="font-size: 0.8rem; cursor: pointer;"><input type="checkbox" id="bookmark-select-all" onchange="toggleAllBookmarks()"> å…¨é¸æŠ</label>
                    <button onclick="deleteSelectedBookmarks()" style="margin-left: 8px; padding: 2px 8px; font-size: 0.75rem; background: #fee2e2; border: 1px solid #fecaca; border-radius: 4px; cursor: pointer;">ğŸ—‘ é¸æŠå‰Šé™¤</button>
                </div>
                <div id="bookmark-list"></div>
            </div>
        </div>
        <div id="outline-summary" class="outline-summary"></div>
    </div>
</div>

<div class="focus-exit-hint">ESCã‚­ãƒ¼ã§é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤</div>

<div id="celebration-overlay" class="celebration-overlay"></div>
<div id="celebration-message" class="celebration-message">
    <span class="emoji">ğŸ‰</span>
    <span id="celebration-text">ã‚„ã£ãŸã­ï¼</span>
    <span class="sub" id="celebration-sub"></span>
</div>

<div id="quick-insert-popup" class="quick-insert-popup">
    <button class="qip-ruby" onclick="quickInsertRuby()">ğŸ”¤ãƒ«ãƒ“</button>
    <button class="qip-bouten" onclick="quickInsertBouten()">âš«å‚ç‚¹</button>
    <button style="color:#d97706;" onclick="quickAddBookmark()">ğŸ”–ã—ãŠã‚Š</button>
</div>

<div id="save-dialog-overlay" class="save-dialog-overlay" style="display:none;">
    <div class="save-dialog">
        <h3>ä¿å­˜å½¢å¼ã‚’é¸æŠ</h3>
        <div style="margin-bottom: 15px; font-size: 0.85rem;">
            <label style="display: block; margin-bottom: 5px;">
                <input type="radio" name="save-scope" value="current" checked> ç¾åœ¨ã®ã‚¿ãƒ–ã®ã¿
            </label>
            <label style="display: block;">
                <input type="radio" name="save-scope" value="all"> å…¨ã‚¿ãƒ–ã‚’çµåˆï¼ˆç« åŒºåˆ‡ã‚Šä»˜ãï¼‰
            </label>
        </div>
        <div class="save-dialog-buttons">
            <button class="btn" onclick="saveAsText()">ğŸ“„ ãƒ†ã‚­ã‚¹ãƒˆ</button>
            <button class="btn" onclick="saveAsHTML()">ğŸŒ HTML</button>
            <button class="btn" onclick="closeSaveDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="memo-save-dialog" class="save-dialog-overlay" style="display:none;">
    <div class="save-dialog" style="background:#fefce8;">
        <h3>ğŸ“ ãƒ¡ãƒ¢ã‚’ä¿å­˜</h3>
        <div style="margin-bottom: 15px; font-size: 0.85rem;">
            <label style="display: block; margin-bottom: 5px;">
                <input type="radio" name="memo-save-scope" value="current" checked> ç¾åœ¨ã®ã‚¿ãƒ–ã®ã¿
            </label>
            <label style="display: block;">
                <input type="radio" name="memo-save-scope" value="all"> å…¨ã‚¿ãƒ–ã‚’çµåˆ
            </label>
        </div>
        <div class="save-dialog-buttons">
            <button class="btn" onclick="executeMemoSave()">ğŸ’¾ ä¿å­˜</button>
            <button class="btn" onclick="closeMemoSaveDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
</div>

<div id="analysis-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header"><h3>ğŸ“Š ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ</h3><button class="modal-close" onclick="closeAnalysis()">âœ•</button></div>
        <div id="analysis-results"></div>
    </div>
</div>

<div id="jump-dialog" class="jump-dialog">
    <h4>è¡Œç•ªå·ã‚¸ãƒ£ãƒ³ãƒ—</h4>
    <input type="number" id="jump-line-input" placeholder="è¡Œç•ªå·ã‚’å…¥åŠ›..." min="1">
    <div class="jump-dialog-buttons">
        <button class="btn" onclick="executeJump()">ã‚¸ãƒ£ãƒ³ãƒ—</button>
        <button class="btn" onclick="closeJumpDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<script>
    const inputArea = document.getElementById('input-area');
    const inputMirror = document.getElementById('input-mirror-container');
    const previewContent = document.getElementById('preview-content');
    const previewScroll = document.getElementById('preview-scroll');
    const inputPosBar = document.getElementById('input-pos-bar');
    const previewPosBar = document.getElementById('preview-pos-bar');
    const charCountEl = document.getElementById('char-count');
    const lineCountEl = document.getElementById('line-count');
    const inputNetCountEl = document.getElementById('input-net-count');
    const inputGoalEl = document.getElementById('input-goal-display');
    const inputTodayGoalEl = document.getElementById('input-today-goal');
    const inputWritingTimeEl = document.getElementById('input-writing-time');
    const inputReadingEl = document.getElementById('input-reading-time');
    const inputManuscriptEl = document.getElementById('input-manuscript');
    const inputSelOverlay = document.getElementById('input-sel-overlay');
    const pvTotalCountEl = document.getElementById('pv-total-count');
    const pvNetCountEl = document.getElementById('pv-net-count');
    const pvLineCountEl = document.getElementById('pv-line-count');
    const pvTimeEl = document.getElementById('pv-time');
    const pvGoalEl = document.getElementById('pv-goal-display');
    const pvTodayGoalEl = document.getElementById('pv-today-goal');
    const pvReadingEl = document.getElementById('pv-reading-time');
    const pvManuscriptEl = document.getElementById('pv-manuscript');
    const previewSelOverlay = document.getElementById('preview-sel-overlay');
    const btnSwap = document.getElementById('btn-layout-swap');

    let layoutAxis = 'row', layoutReversed = false;

    let settingsCache = {
        goalChars: 150000, todayGoal: 2000, manuscriptRows: 34, manuscriptCols: 42,
        showReadingTime: true, showManuscript: true, showSpace: true, showHighlight: true,
        typewriterMode: false, writingTracker: true, defaultPreviewHidden: false,
        celebrateGoal: true
    };
    let goalAchieved = { today: false, total: false };
    let previewUpdateTimeout = null;

    const TODAY_START_KEY = 'cc_editor_today_start';
    const WRITING_TIME_KEY = 'cc_editor_writing_time';
    const BOOKMARKS_KEY = 'cc_editor_bookmarks';
    const SETTINGS_KEY = 'cc_editor_settings';
    const TABS_KEY = 'cc_editor_tabs';
    let todayStartChars = 0, writingSeconds = 0, lastInputTime = 0, writingTimerInterval = null, bookmarks = [];

    // Utility function - must be defined before use in renderInputTabs
    function escapeHtml(s) { return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])); }

    // Input Tabs System
    let inputTabs = [{ id: 1, name: 'ç¬¬1ç« ', content: '' }];
    let activeTabId = 1;
    let nextTabId = 2;

    function renderInputTabs() {
        const container = document.getElementById('input-tabs-container');
        container.innerHTML = '';
        inputTabs.forEach(tab => {
            const tabEl = document.createElement('div');
            tabEl.className = 'input-tab' + (tab.id === activeTabId ? ' active' : '');
            tabEl.innerHTML = `
                <span class="tab-name" ondblclick="startEditTabName(${tab.id})">${escapeHtml(tab.name)}</span>
                ${inputTabs.length > 1 ? `<span class="tab-close" onclick="event.stopPropagation(); deleteTab(${tab.id})">âœ•</span>` : ''}
            `;
            tabEl.onclick = () => switchTab(tab.id);
            container.appendChild(tabEl);
        });
        const addBtn = document.createElement('button');
        addBtn.className = 'input-tab-add';
        addBtn.textContent = 'ï¼‹';
        addBtn.title = 'æ–°ã—ã„ã‚¿ãƒ–ã‚’è¿½åŠ ';
        addBtn.onclick = addNewTab;
        container.appendChild(addBtn);
        updatePreviewTabOptions();
    }

    function switchTab(tabId) {
        // Save current tab content
        const currentTab = inputTabs.find(t => t.id === activeTabId);
        if (currentTab) currentTab.content = inputArea.value;
        // Switch to new tab
        activeTabId = tabId;
        const newTab = inputTabs.find(t => t.id === tabId);
        if (newTab) inputArea.value = newTab.content;
        renderInputTabs();
        updateInputStats();
        // Preview tab stays independent - only update content if showing current input tab
        if (!previewShowAll && previewTabId === null) {
            updatePreview();
            renderPreviewTabs();
        }
        saveTabsToStorage();
    }

    function addNewTab() {
        const currentTab = inputTabs.find(t => t.id === activeTabId);
        if (currentTab) currentTab.content = inputArea.value;
        const newTab = { id: nextTabId++, name: `ç¬¬${inputTabs.length + 1}ç« `, content: '' };
        inputTabs.push(newTab);
        activeTabId = newTab.id;
        inputArea.value = '';
        renderInputTabs();
        updateInputStats();
        updatePreview();
        saveTabsToStorage();
    }

    function deleteTab(tabId) {
        if (inputTabs.length <= 1) return;
        if (!confirm('ã“ã®ã‚¿ãƒ–ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const idx = inputTabs.findIndex(t => t.id === tabId);
        inputTabs.splice(idx, 1);
        if (activeTabId === tabId) {
            activeTabId = inputTabs[Math.max(0, idx - 1)].id;
            inputArea.value = inputTabs.find(t => t.id === activeTabId).content;
        }
        renderInputTabs();
        updateInputStats();
        updatePreview();
        saveTabsToStorage();
    }

    function startEditTabName(tabId) {
        const container = document.getElementById('input-tabs-container');
        const tabEl = container.querySelector(`.input-tab.active .tab-name`) || container.querySelector(`.input-tab:nth-child(${inputTabs.findIndex(t => t.id === tabId) + 1}) .tab-name`);
        const tab = inputTabs.find(t => t.id === tabId);
        if (!tabEl || !tab) return;
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'tab-name-input';
        input.value = tab.name;
        input.onblur = () => finishEditTabName(tabId, input.value);
        input.onkeydown = e => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { input.value = tab.name; input.blur(); } };
        tabEl.replaceWith(input);
        input.focus();
        input.select();
    }

    function finishEditTabName(tabId, newName) {
        const tab = inputTabs.find(t => t.id === tabId);
        if (tab) tab.name = newName.trim() || tab.name;
        renderInputTabs();
        saveTabsToStorage();
    }

    function saveTabsToStorage() {
        const currentTab = inputTabs.find(t => t.id === activeTabId);
        if (currentTab) currentTab.content = inputArea.value;
        localStorage.setItem(TABS_KEY, JSON.stringify({ tabs: inputTabs, activeTabId, nextTabId }));
    }

    function loadTabsFromStorage() {
        const s = localStorage.getItem(TABS_KEY);
        if (s) {
            try {
                const d = JSON.parse(s);
                if (d.tabs && d.tabs.length > 0) {
                    inputTabs = d.tabs;
                    activeTabId = d.activeTabId || inputTabs[0].id;
                    nextTabId = d.nextTabId || inputTabs.length + 1;
                    const activeTab = inputTabs.find(t => t.id === activeTabId);
                    if (activeTab) inputArea.value = activeTab.content;
                    return true;
                }
            } catch (e) {}
        }
        return false;
    }

    function getAllTabsContent() {
        const currentTab = inputTabs.find(t => t.id === activeTabId);
        if (currentTab) currentTab.content = inputArea.value;
        let combined = '';
        inputTabs.forEach((tab, idx) => {
            if (idx > 0) combined += '\n\n';
            combined += `â—† ${tab.name}\n\n${tab.content}`;
        });
        return combined;
    }

    function getCurrentTabContent() {
        return inputArea.value;
    }

    function getTodayDateStr() { const n = new Date(); return `${n.getFullYear()}-${(n.getMonth()+1).toString().padStart(2,'0')}-${n.getDate().toString().padStart(2,'0')}`; }

    function loadTodayStart() {
        const s = localStorage.getItem(TODAY_START_KEY);
        if (s) { try { const d = JSON.parse(s); if (d.date === getTodayDateStr()) { todayStartChars = d.startChars; return; } } catch (e) {} }
        saveTodayStart();
    }
    function saveTodayStart() { const n = inputArea.value.replace(/[\n\sã€€]/g, '').length; todayStartChars = n; localStorage.setItem(TODAY_START_KEY, JSON.stringify({ date: getTodayDateStr(), startChars: n })); }
    function resetTodayStart() { if (confirm('ä»Šæ—¥ã®é–‹å§‹ç‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) { saveTodayStart(); updateInputStats(); updatePreview(); } }

    function loadWritingTime() {
        const s = localStorage.getItem(WRITING_TIME_KEY);
        if (s) { try { const d = JSON.parse(s); if (d.date === getTodayDateStr()) { writingSeconds = d.seconds; return; } } catch (e) {} }
        writingSeconds = 0; saveWritingTime();
    }
    function saveWritingTime() { localStorage.setItem(WRITING_TIME_KEY, JSON.stringify({ date: getTodayDateStr(), seconds: writingSeconds })); }
    function formatTime(s) { return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
    function updateWritingTimeDisplay() {
        const t = formatTime(writingSeconds);
        document.getElementById('writing-time-display').textContent = `åŸ·ç­†æ™‚é–“: ${t}`;
        inputWritingTimeEl.textContent = settingsCache.writingTracker ? `â±${t}` : '';
    }
    function startWritingTimer() {
        if (writingTimerInterval) return;
        writingTimerInterval = setInterval(() => { if (Date.now() - lastInputTime < 5000) { writingSeconds++; updateWritingTimeDisplay(); if (writingSeconds % 30 === 0) saveWritingTime(); } }, 1000);
    }

    function loadBookmarks() { const s = localStorage.getItem(BOOKMARKS_KEY); if (s) { try { bookmarks = JSON.parse(s); } catch (e) { bookmarks = []; } } renderBookmarks(); }
    function saveBookmarks() { localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks)); }
    function addBookmark() {
        const pos = inputArea.selectionStart, text = inputArea.value;
        const lineStart = text.lastIndexOf('\n', pos - 1) + 1, lineEnd = text.indexOf('\n', pos);
        const lineText = text.substring(lineStart, lineEnd === -1 ? text.length : lineEnd).trim();
        const preview = lineText.substring(0, 30) + (lineText.length > 30 ? '...' : '');
        const lineNum = (text.substring(0, pos).match(/\n/g) || []).length + 1;
        bookmarks.push({ pos, lineNum, preview, created: Date.now() }); saveBookmarks(); renderBookmarks();
    }
    function deleteBookmark(i) { bookmarks.splice(i, 1); saveBookmarks(); renderBookmarks(); }
    function jumpToBookmark(pos) { inputArea.focus(); inputArea.setSelectionRange(pos, pos); setTimeout(() => scrollToCursorPosition(pos), 100); updateCursorLineDisplay(); }
    function toggleAllBookmarks() {
        const checked = document.getElementById('bookmark-select-all').checked;
        document.querySelectorAll('.bookmark-checkbox').forEach(cb => cb.checked = checked);
    }
    function deleteSelectedBookmarks() {
        const checkboxes = document.querySelectorAll('.bookmark-checkbox:checked');
        if (checkboxes.length === 0) return;
        if (!confirm(`${checkboxes.length}ä»¶ã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
        indices.forEach(i => bookmarks.splice(i, 1));
        saveBookmarks(); renderBookmarks();
        document.getElementById('bookmark-select-all').checked = false;
    }
    function renderBookmarks() {
        const l = document.getElementById('bookmark-list'); l.innerHTML = '';
        const actions = document.getElementById('bookmark-actions');
        if (bookmarks.length === 0) { l.innerHTML = '<div class="outline-empty">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>'; actions.style.display = 'none'; return; }
        actions.style.display = 'block';
        bookmarks.forEach((b, i) => { const d = document.createElement('div'); d.className = 'bookmark-item'; d.innerHTML = `<input type="checkbox" class="bookmark-checkbox" data-index="${i}" style="margin-right:6px;"><span class="bookmark-text" onclick="jumpToBookmark(${b.pos})">ğŸ“ ${b.lineNum}è¡Œç›®: ${escapeHtml(b.preview)}</span><span class="bookmark-delete" onclick="deleteBookmark(${i})">âœ•</span>`; l.appendChild(d); });
    }

    // è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function collectAllSettings() {
        return {
            version: '3.5',
            input: { size: document.getElementById('st-in-size').value, line: document.getElementById('st-in-line').value, font: document.getElementById('st-in-font').value, vertical: document.getElementById('st-in-v').checked },
            preview: { size: document.getElementById('st-pv-size').value, line: document.getElementById('st-pv-line').value, font: document.getElementById('st-pv-font').value, vertical: document.getElementById('st-pv-v').checked },
            display: { showSpace: document.getElementById('st-show-space').checked, showHighlight: document.getElementById('st-show-highlight').checked, showInput: document.getElementById('check-show-input').checked, showPreview: document.getElementById('check-show-preview').checked, defaultPreviewHidden: document.getElementById('st-default-preview-hidden').checked },
            writing: { typewriter: document.getElementById('st-typewriter-mode').checked, tracker: document.getElementById('st-writing-tracker').checked },
            goal: { chars: document.getElementById('st-goal-chars').value, today: document.getElementById('st-today-goal').value, showReading: document.getElementById('st-show-reading-time').checked, celebrate: document.getElementById('st-celebrate-goal').checked },
            manuscript: { rows: document.getElementById('st-manuscript-rows').value, cols: document.getElementById('st-manuscript-cols').value, show: document.getElementById('st-show-manuscript').checked },
            theme: document.getElementById('st-theme-preset').value
        };
    }
    function applyImportedSettings(s) {
        if (s.input) { document.getElementById('st-in-size').value = s.input.size || 17; document.getElementById('st-in-line').value = s.input.line || 1.7; document.getElementById('st-in-font').value = s.input.font || 'font-mincho'; document.getElementById('st-in-v').checked = s.input.vertical !== false; }
        if (s.preview) { document.getElementById('st-pv-size').value = s.preview.size || 17; document.getElementById('st-pv-line').value = s.preview.line || 1.7; document.getElementById('st-pv-font').value = s.preview.font || 'font-mincho'; document.getElementById('st-pv-v').checked = s.preview.vertical !== false; }
        if (s.display) { document.getElementById('st-show-space').checked = s.display.showSpace !== false; document.getElementById('st-show-highlight').checked = s.display.showHighlight !== false; document.getElementById('check-show-input').checked = s.display.showInput !== false; document.getElementById('check-show-preview').checked = s.display.showPreview !== false; document.getElementById('st-default-preview-hidden').checked = s.display.defaultPreviewHidden || false; }
        if (s.writing) { document.getElementById('st-typewriter-mode').checked = s.writing.typewriter || false; document.getElementById('st-writing-tracker').checked = s.writing.tracker !== false; }
        if (s.goal) { document.getElementById('st-goal-chars').value = s.goal.chars || 150000; document.getElementById('st-today-goal').value = s.goal.today || 2000; document.getElementById('st-show-reading-time').checked = s.goal.showReading !== false; document.getElementById('st-celebrate-goal').checked = s.goal.celebrate !== false; }
        if (s.manuscript) { document.getElementById('st-manuscript-rows').value = s.manuscript.rows || 34; document.getElementById('st-manuscript-cols').value = s.manuscript.cols || 42; document.getElementById('st-show-manuscript').checked = s.manuscript.show !== false; }
        if (s.theme !== undefined) document.getElementById('st-theme-preset').value = s.theme;
        applyAllSettings();
    }
    function exportSettings() {
        const s = collectAllSettings(); const blob = new Blob([JSON.stringify(s, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `cc_editor_settings_${getTodayDateStr()}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function importSettings(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = e => { try { const s = JSON.parse(e.target.result); applyImportedSettings(s); alert('è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚'); } catch (err) { alert('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); } input.value = ''; };
        reader.readAsText(file);
    }
    function saveSettingsToStorage() { localStorage.setItem(SETTINGS_KEY, JSON.stringify(collectAllSettings())); }
    function loadSettingsFromStorage() { const s = localStorage.getItem(SETTINGS_KEY); if (s) { try { applyImportedSettings(JSON.parse(s)); } catch (e) {} } }

    const defaultText = `ã€€C-ã‚¨ãƒ‡ã‚£ã‚¿

â–  æ–°æ©Ÿèƒ½ãƒ»å¤‰æ›´ç‚¹
ãƒ»åŸç¨¿ç”¨ç´™ã®åˆæœŸè¨­å®šã‚’42å­—Ã—34è¡Œã«å¤‰æ›´
ãƒ»è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ 
ãƒ»ãƒŸãƒ‹ãƒãƒƒãƒ—æ©Ÿèƒ½ã‚’å‰Šé™¤ï¼ˆå®‰å®šæ€§å‘ä¸Šã®ãŸã‚ï¼‰

â–¡ è¨­å®šç®¡ç†æ©Ÿèƒ½
è¨­å®šãƒ‘ãƒãƒ«ã®ã€Œè¨­å®šç®¡ç†ã€ã‹ã‚‰ï¼š
ãƒ»ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼šç¾åœ¨ã®è¨­å®šã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜
ãƒ»ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼šä¿å­˜ã—ãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿

â–¡ åŸ·ç­†æ”¯æ´æ©Ÿèƒ½
ãƒ»ğŸ§˜ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ï¼ˆESCã§è§£é™¤ï¼‰
ãƒ»ã‚¿ã‚¤ãƒ—ãƒ©ã‚¤ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰
ãƒ»åŸ·ç­†æ™‚é–“ãƒˆãƒ©ãƒƒã‚«ãƒ¼
ãƒ»ğŸ“Š åˆ†ææ©Ÿèƒ½

â–¡ å…¥åŠ›è£œåŠ©
ãƒ»æ”¹è¡Œæ™‚ã«å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’è‡ªå‹•æŒ¿å…¥
ã€€ï¼ˆã“ã®è¡Œã®ã‚ˆã†ã«å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã§å§‹ã¾ã‚‹è¡Œã§æ”¹è¡Œã™ã‚‹ã¨ã€æ¬¡ã®è¡Œã«ã‚‚è‡ªå‹•ã§å…¥ã‚Šã¾ã™ï¼‰

ã€€ã”åŸ·ç­†ã«ãŠå½¹ç«‹ã¦ãã ã•ã„ã€‚`;

    const AUTOSAVE_KEY = 'cc_editor_autosave', AUTOSAVE_INTERVAL = 30000;
    function autoSave() { saveTabsToStorage(); saveSettingsToStorage(); }
    function loadAutoSave() {
        // Try to load tabs first (new format)
        if (loadTabsFromStorage()) {
            renderInputTabs();
            return;
        }
        // Fallback: try old single-content format
        const s = localStorage.getItem(AUTOSAVE_KEY);
        if (s && s.length > 0 && s !== defaultText) {
            if (confirm('å‰å›ã®è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) {
                inputTabs[0].content = s;
                inputArea.value = s;
            } else {
                inputArea.value = defaultText;
                inputTabs[0].content = defaultText;
            }
        } else {
            inputArea.value = defaultText;
            inputTabs[0].content = defaultText;
        }
        renderInputTabs();
    }
    setInterval(autoSave, AUTOSAVE_INTERVAL);
    window.addEventListener('beforeunload', e => { autoSave(); saveWritingTime(); e.preventDefault(); e.returnValue = ''; });

    function undoInput() { inputArea.focus(); document.execCommand('undo'); }
    function redoInput() { inputArea.focus(); document.execCommand('redo'); }
    function getGoalColorClass(p) { if (p >= 100) return 'goal-100'; if (p >= 75) return 'goal-75-99'; if (p >= 50) return 'goal-50-74'; if (p >= 25) return 'goal-25-49'; return 'goal-0-24'; }

    // Celebration Functions
    function launchFireworks() {
        const overlay = document.getElementById('celebration-overlay');
        const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#1dd1a1'];
        const fireworkCount = 8;
        for (let f = 0; f < fireworkCount; f++) {
            setTimeout(() => {
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight * 0.6 + window.innerHeight * 0.1;
                const color = colors[Math.floor(Math.random() * colors.length)];
                // Trail
                const trail = document.createElement('div');
                trail.className = 'firework-trail';
                trail.style.left = x + 'px';
                trail.style.bottom = '0';
                trail.style.background = color;
                trail.style.setProperty('--rise', `-${window.innerHeight - y}px`);
                overlay.appendChild(trail);
                setTimeout(() => trail.remove(), 800);
                // Burst
                setTimeout(() => {
                    const particleCount = 20;
                    for (let i = 0; i < particleCount; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'firework';
                        particle.style.left = x + 'px';
                        particle.style.top = y + 'px';
                        particle.style.background = color;
                        const angle = (i / particleCount) * Math.PI * 2;
                        const distance = 80 + Math.random() * 60;
                        const tx = Math.cos(angle) * distance;
                        const ty = Math.sin(angle) * distance;
                        particle.style.setProperty('--tx', tx + 'px');
                        particle.style.setProperty('--ty', ty + 'px');
                        overlay.appendChild(particle);
                        setTimeout(() => particle.remove(), 1500);
                    }
                }, 600);
            }, f * 200);
        }
    }

    function showCelebration(type) {
        if (!settingsCache.celebrateGoal) return;
        const msgEl = document.getElementById('celebration-message');
        const textEl = document.getElementById('celebration-text');
        const subEl = document.getElementById('celebration-sub');
        if (type === 'today') {
            textEl.textContent = 'ã‚„ã£ãŸã­ï¼ä»Šæ—¥ã®ç›®æ¨™é”æˆï¼';
            subEl.textContent = 'ä»Šæ—¥ã‚‚ç´ æ™´ã‚‰ã—ã„åŸ·ç­†ã§ã—ãŸï¼';
        } else if (type === 'total') {
            textEl.textContent = 'ğŸŠ ãŠã‚ã§ã¨ã†ï¼å…¨ä½“ç›®æ¨™é”æˆï¼ ğŸŠ';
            subEl.textContent = 'å¤§ããªç¯€ç›®ã‚’é”æˆã—ã¾ã—ãŸï¼';
        }
        launchFireworks();
        msgEl.classList.add('show');
        setTimeout(() => msgEl.classList.remove('show'), 4000);
    }

    function checkGoalAchievement(todayWritten, todayGoal, totalWritten, totalGoal) {
        if (todayGoal > 0 && todayWritten >= todayGoal && !goalAchieved.today) {
            goalAchieved.today = true;
            setTimeout(() => showCelebration('today'), 300);
        }
        if (totalGoal > 0 && totalWritten >= totalGoal && !goalAchieved.total) {
            goalAchieved.total = true;
            setTimeout(() => showCelebration('total'), goalAchieved.today ? 4500 : 300);
        }
    }

    // Debounced preview update for performance
    function debouncedPreviewUpdate() {
        if (previewUpdateTimeout) clearTimeout(previewUpdateTimeout);
        previewUpdateTimeout = setTimeout(() => updatePreview(), 300);
    }

    function updateInputStats() {
        const t = inputArea.value, tl = t.replace(/[\n\r]/g, '').length, nl = t.replace(/[\n\sã€€]/g, '').length, ll = t.split('\n').length;
        charCountEl.innerText = `å…¨ä½“: ${tl}`; inputNetCountEl.innerText = `å®Ÿè³ª: ${nl}`; lineCountEl.innerText = `${ll} è¡Œ`;
        const g = settingsCache.goalChars;
        if (g > 0) { const p = Math.round((nl / g) * 100); inputGoalEl.innerText = `ç›®æ¨™: ${nl}/${g} (${p}%)`; inputGoalEl.className = 'goal-display ' + getGoalColorClass(p); } else { inputGoalEl.innerText = ''; }
        const tg = settingsCache.todayGoal;
        let tw = 0;
        if (tg > 0) { tw = Math.max(0, nl - todayStartChars); const tp = Math.round((tw / tg) * 100); inputTodayGoalEl.innerText = `ä»Šæ—¥: ${tw}/${tg} (${tp}%)`; inputTodayGoalEl.className = tw >= tg ? 'today-goal achieved' : 'today-goal'; } else { inputTodayGoalEl.innerText = ''; }
        inputReadingEl.innerText = settingsCache.showReadingTime ? `ç´„${Math.ceil(nl / 400)}åˆ†` : '';
        if (settingsCache.showManuscript) { const cpp = settingsCache.manuscriptRows * settingsCache.manuscriptCols; inputManuscriptEl.innerText = `åŸç¨¿ç”¨ç´™: ${(nl / cpp).toFixed(1)}æš`; } else { inputManuscriptEl.innerText = ''; }
        updateCursorLineDisplay();
        // Check goal achievement
        checkGoalAchievement(tw, tg, nl, g);
    }
    function updateCursorLineDisplay() { const p = inputArea.selectionStart, c = (inputArea.value.substring(0, p).match(/\n/g) || []).length + 1; inputPosBar.innerText = `ç¾åœ¨: ${c} è¡Œç›®`; }

    const quickInsertPopup = document.getElementById('quick-insert-popup');
    let lastSelectionRange = { start: 0, end: 0 };

    function showQuickInsertPopup() {
        const s = inputArea.selectionStart, e = inputArea.selectionEnd;
        if (s === e) { quickInsertPopup.classList.remove('show'); return; }
        lastSelectionRange = { start: s, end: e };
        // Position popup near selection using mirror technique
        const cs = window.getComputedStyle(inputArea);
        inputMirror.style.fontSize = cs.fontSize;
        inputMirror.style.lineHeight = cs.lineHeight;
        inputMirror.style.fontFamily = cs.fontFamily;
        inputMirror.style.width = inputArea.clientWidth + 'px';
        inputMirror.style.height = inputArea.clientHeight + 'px';
        const textBefore = inputArea.value.substring(0, e);
        const marker = document.createElement('span');
        marker.textContent = '|';
        inputMirror.innerHTML = '';
        inputMirror.appendChild(document.createTextNode(textBefore));
        inputMirror.appendChild(marker);
        const markerRect = marker.getBoundingClientRect();
        const inputRect = inputArea.getBoundingClientRect();
        const isVertical = inputArea.parentElement.classList.contains('vertical-mode');
        let popupTop, popupLeft;
        if (isVertical) {
            // Vertical mode: position to the left of selection
            popupTop = Math.min(Math.max(markerRect.top, inputRect.top), inputRect.bottom - 40);
            popupLeft = Math.max(markerRect.left - 120, inputRect.left);
        } else {
            // Horizontal mode: position to the right of selection
            popupTop = Math.min(Math.max(markerRect.top - 10, inputRect.top), inputRect.bottom - 40);
            popupLeft = Math.min(markerRect.right + 10, window.innerWidth - 180);
        }
        quickInsertPopup.style.top = popupTop + 'px';
        quickInsertPopup.style.left = popupLeft + 'px';
        quickInsertPopup.classList.add('show');
    }

    function hideQuickInsertPopup() { quickInsertPopup.classList.remove('show'); }

    function quickInsertRuby() {
        const s = lastSelectionRange.start, e = lastSelectionRange.end;
        if (s === e) return;
        const st = inputArea.value.substring(s, e), b = inputArea.value.substring(0, s), a = inputArea.value.substring(e);
        const rt = `ï½œ${st}ã€Šã€‹`;
        inputArea.value = b + rt + a;
        inputArea.setSelectionRange(s + st.length + 2, s + st.length + 2);
        inputArea.focus();
        updateInputStats();
        hideQuickInsertPopup();
    }

    function quickInsertBouten() {
        const s = lastSelectionRange.start, e = lastSelectionRange.end;
        if (s === e) return;
        const st = inputArea.value.substring(s, e), b = inputArea.value.substring(0, s), a = inputArea.value.substring(e);
        const bt = `ã€Šã€Š${st}ã€‹ã€‹`;
        inputArea.value = b + bt + a;
        inputArea.setSelectionRange(s + bt.length, s + bt.length);
        inputArea.focus();
        updateInputStats();
        hideQuickInsertPopup();
    }

    function quickAddBookmark() {
        const s = lastSelectionRange.start, e = lastSelectionRange.end;
        const pos = s;
        const text = inputArea.value;
        const lineStart = text.lastIndexOf('\n', pos - 1) + 1;
        const lineEnd = text.indexOf('\n', pos);
        const lineText = text.substring(lineStart, lineEnd === -1 ? text.length : lineEnd).trim();
        const preview = lineText.substring(0, 30) + (lineText.length > 30 ? '...' : '');
        const lineNum = (text.substring(0, pos).match(/\n/g) || []).length + 1;
        bookmarks.push({ pos, lineNum, preview, created: Date.now() });
        saveBookmarks();
        renderBookmarks();
        hideQuickInsertPopup();
    }

    document.addEventListener('selectionchange', () => {
        const a = document.activeElement;
        if (a === inputArea) {
            const s = inputArea.selectionStart, e = inputArea.selectionEnd;
            if (s !== e) {
                const t = inputArea.value.substring(s, e), c = t.replace(/[\n\r]/g, '').length, l = (t.match(/\n/g) || []).length + 1;
                inputSelOverlay.textContent = `é¸æŠ: ${c}å­— / ${l}è¡Œ`;
                inputSelOverlay.classList.add('show');
                showQuickInsertPopup();
            } else {
                inputSelOverlay.classList.remove('show');
                hideQuickInsertPopup();
            }
            previewSelOverlay.classList.remove('show');
        }
        else if (previewScroll.contains(window.getSelection()?.anchorNode)) {
            const t = window.getSelection().toString();
            if (t.length > 0) {
                const c = t.replace(/[\n\r]/g, '').length, l = (t.match(/\n/g) || []).length + 1;
                previewSelOverlay.textContent = `é¸æŠ: ${c}å­— / ${l}è¡Œ`;
                previewSelOverlay.classList.add('show');
            } else {
                previewSelOverlay.classList.remove('show');
            }
            inputSelOverlay.classList.remove('show');
            hideQuickInsertPopup();
        }
        else {
            inputSelOverlay.classList.remove('show');
            previewSelOverlay.classList.remove('show');
            hideQuickInsertPopup();
        }
    });

    previewScroll.addEventListener('scroll', () => {
        const v = document.getElementById('st-pv-v').checked; let p;
        if (v) { const sl = previewScroll.scrollLeft, sw = previewScroll.scrollWidth - previewScroll.clientWidth; p = sw > 0 ? Math.round(Math.abs(sl) / sw * 100) : 0; }
        else { const st = previewScroll.scrollTop, sh = previewScroll.scrollHeight - previewScroll.clientHeight; p = sh > 0 ? Math.round((st / sh) * 100) : 0; }
        previewPosBar.innerText = `ä½ç½®: ${p}%`;
    });

    let previewTabId = null; // null = follow input, or specific tab id

    function renderPreviewTabs() {
        const container = document.getElementById('preview-tabs-container');
        if (!container) return;
        container.innerHTML = '';

        // Individual tabs only (removed "å…¨ã‚¿ãƒ–")
        inputTabs.forEach(tab => {
            const tabEl = document.createElement('div');
            const isActive = previewTabId === tab.id || (previewTabId === null && tab.id === activeTabId);
            tabEl.className = 'preview-tab' + (isActive ? ' active' : '');
            tabEl.textContent = tab.name;
            tabEl.onclick = () => { previewTabId = tab.id; renderPreviewTabs(); updatePreview(); };
            container.appendChild(tabEl);
        });
    }

    function getPreviewContent() {
        const currentTab = inputTabs.find(t => t.id === activeTabId);
        if (currentTab) currentTab.content = inputArea.value;

        const targetId = previewTabId !== null ? previewTabId : activeTabId;
        const tab = inputTabs.find(t => t.id === targetId);
        return tab ? tab.content : inputArea.value;
    }

    function updatePreviewTabOptions() {
        renderPreviewTabs();
    }

    function updatePreview() {
        const t = getPreviewContent(), ss = settingsCache.showSpace, sh = settingsCache.showHighlight;
        let s = escapeHtml(t); if (sh) previewContent.classList.add('highlight-active'); else previewContent.classList.remove('highlight-active');
        const MZ = '\uE001', MH = '\uE002'; if (ss) { s = s.replace(/ã€€/g, MZ).replace(/ /g, MH); }
        if (sh) { s = s.replace(/ã€Œ(.*?)ã€/g, '<span class="bracket-blue">ã€Œ$1ã€</span>').replace(/ã€(.*?)ã€/g, '<span class="bracket-green">ã€$1ã€</span>'); }
        s = s.replace(/ï½œ([^ã€Š]+?)ã€Š(.+?)ã€‹/g, '<ruby>$1<rt>$2</rt></ruby>').replace(/([ä¸€-é¾ ã€…ã€†ãƒµãƒ¶]+)ã€Š(.+?)ã€‹/g, '<ruby>$1<rt>$2</rt></ruby>');
        s = s.replace(/ã€Šã€Š(.+?)ã€‹ã€‹/g, (m, p) => { let r = ''; for (let c of p) r += `<ruby class="bouten-ruby">${c}<rt>ãƒ»</rt></ruby>`; return r; });
        s = s.replace(/__(.+?)__/g, '<span class="underline-text">$1</span>').replace(/==(.+?)==/g, '<span class="highlight-text">$1</span>');
        if (sh) s = s.replace(/([â€•â”€]{2,}|â€¦{2,})/g, '<span class="symbol-hl">$1</span>');
        if (ss) { s = s.split(MZ).join('<span class="space-zen">â–¡</span>').split(MH).join('<span class="space-han">ï½¥</span>'); }
        s = s.replace(/\n/g, '<br>'); previewContent.innerHTML = s;
        const tl = t.replace(/[\n\r]/g, '').length, nl = t.replace(/[\n\sã€€ï½œã€Šã€‹]/g, '').length, ll = t.split('\n').length;
        pvTotalCountEl.innerText = `å…¨ä½“: ${tl}`; pvNetCountEl.innerText = `å®Ÿè³ª: ${nl}`; pvLineCountEl.innerText = `${ll} è¡Œ`;
        const g = settingsCache.goalChars; if (g > 0) { const p = Math.round((nl / g) * 100); pvGoalEl.innerText = `ç›®æ¨™: ${nl}/${g} (${p}%)`; pvGoalEl.className = 'goal-display ' + getGoalColorClass(p); } else { pvGoalEl.innerText = ''; }
        const tg = settingsCache.todayGoal; if (tg > 0) { const tw = Math.max(0, nl - todayStartChars), tp = Math.round((tw / tg) * 100); pvTodayGoalEl.innerText = `ä»Šæ—¥: ${tw}/${tg} (${tp}%)`; pvTodayGoalEl.className = tw >= tg ? 'today-goal achieved' : 'today-goal'; } else { pvTodayGoalEl.innerText = ''; }
        pvReadingEl.innerText = settingsCache.showReadingTime ? `ç´„${Math.ceil(nl / 400)}åˆ†` : '';
        if (settingsCache.showManuscript) { const cpp = settingsCache.manuscriptRows * settingsCache.manuscriptCols; pvManuscriptEl.innerText = `åŸç¨¿ç”¨ç´™: ${(nl / cpp).toFixed(1)}æš`; } else { pvManuscriptEl.innerText = ''; }
        pvTimeEl.innerText = `æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP', { hour12: false })}`;
    }

    function syncPreviewPosition() {
        // Match preview tab to input tab first
        if (previewTabId !== activeTabId) {
            previewTabId = activeTabId;
            renderPreviewTabs();
        }
        updatePreview();

        // Get cursor line
        const p = inputArea.selectionStart;
        const lineNum = (inputArea.value.substring(0, p).match(/\n/g) || []).length;

        // Find corresponding position in preview and scroll to center
        const isVertical = previewScroll.classList.contains('vertical-mode');
        const brs = previewContent.querySelectorAll('br');

        if (brs.length > 0) {
            const targetBr = brs[Math.min(lineNum, brs.length - 1)];
            if (targetBr) {
                targetBr.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
            }
        } else if (isVertical) {
            previewScroll.scrollLeft = 0;
        } else {
            previewScroll.scrollTop = 0;
        }
    }

    // Alias for compatibility
    function doSyncPreviewToInput() {
        syncPreviewPosition();
    }

    function updatePreviewAndShow() {
        updatePreview();
        const previewPane = document.getElementById('pane-preview');
        if (previewPane.classList.contains('hidden')) {
            previewPane.classList.remove('hidden');
            document.getElementById('check-show-preview').checked = true;
        }
    }

    const fontMap = { 'font-gothic': '"Noto Sans JP", sans-serif', 'font-mincho': '"Shippori Mincho", serif', 'font-old': '"Zen Old Mincho", serif', 'font-round': '"M PLUS Rounded 1c", sans-serif', 'font-brush': '"Yuji Syuku", serif' };
    function applyInputSettings() { const s = document.getElementById('st-in-size').value + 'px', l = document.getElementById('st-in-line').value, f = fontMap[document.getElementById('st-in-font').value], v = document.getElementById('st-in-v').checked; inputArea.style.fontSize = s; inputArea.style.lineHeight = l; inputArea.style.fontFamily = f; inputMirror.style.fontSize = s; inputMirror.style.lineHeight = l; inputMirror.style.fontFamily = f; if (v) inputArea.parentElement.classList.add('vertical-mode'); else inputArea.parentElement.classList.remove('vertical-mode'); }
    function applyPreviewSettings() { const s = document.getElementById('st-pv-size').value + 'px', l = document.getElementById('st-pv-line').value, f = fontMap[document.getElementById('st-pv-font').value], v = document.getElementById('st-pv-v').checked; previewContent.style.fontSize = s; previewContent.style.lineHeight = l; previewContent.style.fontFamily = f; if (v) previewScroll.classList.add('vertical-mode'); else previewScroll.classList.remove('vertical-mode'); updatePreview(); }
    function applyDisplaySettings() { settingsCache.showSpace = document.getElementById('st-show-space').checked; settingsCache.showHighlight = document.getElementById('st-show-highlight').checked; settingsCache.defaultPreviewHidden = document.getElementById('st-default-preview-hidden').checked; const si = document.getElementById('check-show-input').checked, sp = document.getElementById('check-show-preview').checked; if (si) document.getElementById('pane-input').classList.remove('hidden'); else document.getElementById('pane-input').classList.add('hidden'); if (sp) document.getElementById('pane-preview').classList.remove('hidden'); else document.getElementById('pane-preview').classList.add('hidden'); adjustPaneWidthsOnVisibility(); updatePreview(); }
    function applyWritingSettings() { settingsCache.typewriterMode = document.getElementById('st-typewriter-mode').checked; settingsCache.writingTracker = document.getElementById('st-writing-tracker').checked; updateWritingTimeDisplay(); }
    function applyGoalSettings() { settingsCache.goalChars = parseInt(document.getElementById('st-goal-chars').value) || 0; settingsCache.todayGoal = parseInt(document.getElementById('st-today-goal').value) || 0; settingsCache.showReadingTime = document.getElementById('st-show-reading-time').checked; settingsCache.celebrateGoal = document.getElementById('st-celebrate-goal').checked; goalAchieved = { today: false, total: false }; updateInputStats(); updatePreview(); }
    function applyManuscriptSettings() { settingsCache.manuscriptRows = parseInt(document.getElementById('st-manuscript-rows').value) || 34; settingsCache.manuscriptCols = parseInt(document.getElementById('st-manuscript-cols').value) || 42; settingsCache.showManuscript = document.getElementById('st-show-manuscript').checked; updateInputStats(); updatePreview(); }
    function applyThemeSettings() { const t = document.getElementById('st-theme-preset').value; document.body.className = document.body.className.replace(/theme-\w+/g, '').trim(); if (t) document.body.classList.add(t); }
    function applyAllSettings() { applyInputSettings(); applyPreviewSettings(); applyDisplaySettings(); applyWritingSettings(); applyGoalSettings(); applyManuscriptSettings(); applyThemeSettings(); }

    function resetAllSettings() {
        if (!confirm('å…¨ã¦ã®è¨­å®šã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
        // Reset to defaults
        document.getElementById('st-in-size').value = 16;
        document.getElementById('st-in-line').value = 2.0;
        document.getElementById('st-in-font').value = 'font-mincho';
        document.getElementById('st-in-v').checked = false;
        document.getElementById('st-pv-size').value = 16;
        document.getElementById('st-pv-line').value = 2.0;
        document.getElementById('st-pv-font').value = 'font-mincho';
        document.getElementById('st-pv-v').checked = false;
        document.getElementById('check-show-input').checked = true;
        document.getElementById('check-show-preview').checked = true;
        document.getElementById('st-show-space').checked = true;
        document.getElementById('st-show-highlight').checked = true;
        document.getElementById('st-default-preview-hidden').checked = false;
        document.getElementById('st-typewriter-mode').checked = false;
        document.getElementById('st-writing-tracker').checked = true;
        document.getElementById('st-goal-chars').value = 150000;
        document.getElementById('st-today-goal').value = 2000;
        document.getElementById('st-celebrate-goal').checked = true;
        document.getElementById('st-show-reading-time').checked = true;
        document.getElementById('st-manuscript-rows').value = 34;
        document.getElementById('st-manuscript-cols').value = 42;
        document.getElementById('st-show-manuscript').checked = true;
        document.getElementById('st-theme-preset').value = '';
        document.getElementById('st-pane-input-width').value = 50;
        document.getElementById('st-pane-preview-width').value = 50;
        applyAllSettings();
        resetPaneWidths();
        localStorage.removeItem(SETTINGS_KEY);
    }

    function applyPaneWidthSettings() {
        const inputWidth = parseInt(document.getElementById('st-pane-input-width').value) || 50;
        const previewWidth = parseInt(document.getElementById('st-pane-preview-width').value) || 50;
        const inputPane = document.getElementById('pane-input');
        const previewPane = document.getElementById('pane-preview');
        const clampedInput = Math.max(10, Math.min(90, inputWidth));
        const clampedPreview = Math.max(10, Math.min(90, previewWidth));
        inputPane.style.flex = `0 0 ${clampedInput}%`;
        previewPane.style.flex = `0 0 ${clampedPreview}%`;
        localStorage.setItem('cc_pane_input_width', clampedInput);
        localStorage.setItem('cc_pane_preview_width', clampedPreview);
    }

    function resetPaneWidths() {
        document.getElementById('st-pane-input-width').value = 50;
        document.getElementById('st-pane-preview-width').value = 50;
        const inputPane = document.getElementById('pane-input');
        const previewPane = document.getElementById('pane-preview');
        inputPane.style.flex = '1 1 50%';
        previewPane.style.flex = '1 1 50%';
        localStorage.removeItem('cc_pane_input_width');
        localStorage.removeItem('cc_pane_preview_width');
    }

    function loadPaneWidthSettings() {
        const inputWidth = localStorage.getItem('cc_pane_input_width');
        const previewWidth = localStorage.getItem('cc_pane_preview_width');
        if (inputWidth) {
            document.getElementById('st-pane-input-width').value = inputWidth;
            document.getElementById('pane-input').style.flex = `0 0 ${inputWidth}%`;
        }
        if (previewWidth) {
            document.getElementById('st-pane-preview-width').value = previewWidth;
            document.getElementById('pane-preview').style.flex = `0 0 ${previewWidth}%`;
        }
    }

    const pinnedPanels = new Set();
    function togglePanel(id) {
        const p = document.getElementById(id);
        const btn = document.querySelector(`#${id} .panel-pin-btn`);
        if (p.classList.contains('open')) {
            if (pinnedPanels.has(id)) {
                // If pinned, unpin and close
                pinnedPanels.delete(id);
                if (btn) btn.classList.remove('pinned');
                p.classList.remove('open');
            } else {
                // If open but not pinned, pin it
                pinnedPanels.add(id);
                if (btn) btn.classList.add('pinned');
            }
        } else {
            // Close non-pinned panels
            document.querySelectorAll('.control-panel.open').forEach(x => {
                if (!pinnedPanels.has(x.id) && x.id !== id) x.classList.remove('open');
            });
            p.classList.add('open');
            if (id === 'search-bar') setTimeout(() => document.getElementById('search-input').focus(), 100);
        }
    }
    function togglePanelPin(id) {
        const btn = document.querySelector(`#${id} .panel-pin-btn`);
        if (pinnedPanels.has(id)) {
            pinnedPanels.delete(id);
            btn.classList.remove('pinned');
        } else {
            pinnedPanels.add(id);
            btn.classList.add('pinned');
        }
    }
    // Close non-pinned panels on outside click
    document.addEventListener('click', e => {
        if (e.target.closest('.control-panel') || e.target.closest('.btn') || e.target.closest('.dropdown')) return;
        document.querySelectorAll('.control-panel.open').forEach(p => {
            if (!pinnedPanels.has(p.id)) p.classList.remove('open');
        });
    });
    // Close non-docked memo/outline when clicking on panes
    document.getElementById('pane-input').addEventListener('click', e => {
        if (e.target.closest('.input-tab') || e.target.closest('.input-tab-add')) return;
        const mainContainer = document.getElementById('main-container');
        if (!mainContainer.classList.contains('memo-docked')) {
            document.getElementById('memo-panel').classList.remove('open');
        }
        if (!mainContainer.classList.contains('outline-docked')) {
            document.getElementById('outline-panel').classList.remove('open');
        }
    });
    document.getElementById('pane-preview').addEventListener('click', e => {
        if (e.target.closest('.preview-tab')) return;
        const mainContainer = document.getElementById('main-container');
        if (!mainContainer.classList.contains('memo-docked')) {
            document.getElementById('memo-panel').classList.remove('open');
        }
        if (!mainContainer.classList.contains('outline-docked')) {
            document.getElementById('outline-panel').classList.remove('open');
        }
    });
    function hidePane(t) {
        if (t === 'input') {
            document.getElementById('check-show-input').checked = false;
            document.getElementById('pane-input').classList.add('hidden');
        } else if (t === 'preview') {
            document.getElementById('check-show-preview').checked = false;
            document.getElementById('pane-preview').classList.add('hidden');
        }
        adjustPaneWidthsOnVisibility();
    }

    function adjustPaneWidthsOnVisibility() {
        const inputPane = document.getElementById('pane-input');
        const previewPane = document.getElementById('pane-preview');
        const inputHidden = inputPane.classList.contains('hidden');
        const previewHidden = previewPane.classList.contains('hidden');
        if (inputHidden && !previewHidden) {
            previewPane.style.flex = '1 1 100%';
        } else if (!inputHidden && previewHidden) {
            inputPane.style.flex = '1 1 100%';
        } else if (!inputHidden && !previewHidden) {
            // Restore saved widths or default 50/50
            const savedInput = localStorage.getItem('cc_pane_input_width');
            const savedPreview = localStorage.getItem('cc_pane_preview_width');
            if (savedInput) inputPane.style.flex = `0 0 ${savedInput}%`;
            else inputPane.style.flex = '1 1 50%';
            if (savedPreview) previewPane.style.flex = `0 0 ${savedPreview}%`;
            else previewPane.style.flex = '1 1 50%';
        }
    }
    function toggleDropdown(id) { document.getElementById(id).classList.toggle('show'); }
    document.addEventListener('click', e => { if (!e.target.closest('.dropdown')) document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show')); });

    function toggleFocusMode() { document.body.classList.toggle('focus-mode'); document.getElementById('btn-focus').classList.toggle('active'); if (document.body.classList.contains('focus-mode')) inputArea.focus(); }

    inputArea.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
            const p = inputArea.selectionStart, t = inputArea.value, ls = t.lastIndexOf('\n', p - 1) + 1, cl = t.substring(ls, p);
            if (cl.startsWith('ã€€')) { e.preventDefault(); const b = t.substring(0, p), a = t.substring(inputArea.selectionEnd); inputArea.value = b + '\nã€€' + a; const np = p + 2; inputArea.setSelectionRange(np, np); updateInputStats(); if (settingsCache.typewriterMode) setTimeout(() => scrollToCursorPosition(np), 10); }
        }
    });
    inputArea.addEventListener('input', () => { lastInputTime = Date.now(); updateInputStats(); if (settingsCache.typewriterMode) scrollToCursorPosition(inputArea.selectionStart); });

    function insertText(t, o = 0) { const s = inputArea.selectionStart, e = inputArea.selectionEnd, b = inputArea.value.substring(0, s), a = inputArea.value.substring(e); inputArea.value = b + t + a; const np = s + t.length - o; inputArea.setSelectionRange(np, np); inputArea.focus(); updateInputStats(); document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show')); }
    function insertRubyToSelection() { const s = inputArea.selectionStart, e = inputArea.selectionEnd; if (s === e) { alert('ãƒ«ãƒ“ã‚’ä»˜ã‘ãŸã„æ–‡å­—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; } const st = inputArea.value.substring(s, e), b = inputArea.value.substring(0, s), a = inputArea.value.substring(e), rt = `ï½œ${st}ã€Šã€‹`; inputArea.value = b + rt + a; inputArea.setSelectionRange(s + st.length + 2, s + st.length + 2); inputArea.focus(); updateInputStats(); document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show')); }
    function insertBoutenToSelection() { const s = inputArea.selectionStart, e = inputArea.selectionEnd; if (s === e) { alert('å‚ç‚¹ã‚’ä»˜ã‘ãŸã„æ–‡å­—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; } const st = inputArea.value.substring(s, e), b = inputArea.value.substring(0, s), a = inputArea.value.substring(e), bt = `ã€Šã€Š${st}ã€‹ã€‹`; inputArea.value = b + bt + a; inputArea.setSelectionRange(s + bt.length, s + bt.length); inputArea.focus(); updateInputStats(); document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show')); }

    function scrollToCursorPosition(idx) {
        const t = inputArea.value, v = document.getElementById('st-in-v').checked, cs = window.getComputedStyle(inputArea);
        inputMirror.style.fontSize = cs.fontSize; inputMirror.style.lineHeight = cs.lineHeight; inputMirror.style.fontFamily = cs.fontFamily; inputMirror.style.width = inputArea.clientWidth + 'px'; inputMirror.style.height = inputArea.clientHeight + 'px';
        const tc = t.substring(0, idx), m = document.createElement('span'); m.textContent = '|'; inputMirror.innerHTML = ''; inputMirror.appendChild(document.createTextNode(tc)); inputMirror.appendChild(m);
        const mr = m.getBoundingClientRect(), mir = inputMirror.getBoundingClientRect(), mot = mr.top - mir.top + inputMirror.scrollTop, mol = mr.left - mir.left + inputMirror.scrollLeft;
        if (v) inputArea.scrollLeft = mol - (inputArea.clientWidth / 2); else inputArea.scrollTop = mot - (inputArea.clientHeight / 2);
    }

    let searchMatches = [], currentMatchIndex = -1;
    function doSearch() { const q = document.getElementById('search-input').value, t = inputArea.value; searchMatches = []; currentMatchIndex = -1; if (!q) { updateSearchInfo(); return; } const esc = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), rx = new RegExp(esc, 'g'); let m; while ((m = rx.exec(t)) !== null) searchMatches.push({ start: m.index, end: m.index + m[0].length }); if (searchMatches.length > 0) { currentMatchIndex = 0; jumpToMatch(); } updateSearchInfo(); }
    function updateSearchInfo() { const i = document.getElementById('search-match-info'); if (searchMatches.length === 0) { i.innerText = '0 / 0'; i.style.color = '#999'; } else { i.innerText = `${currentMatchIndex + 1} / ${searchMatches.length}`; i.style.color = '#15803d'; } }
    function findNext() { if (searchMatches.length === 0) doSearch(); else { currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length; jumpToMatch(); updateSearchInfo(); } }
    function findPrev() { if (searchMatches.length === 0) doSearch(); else { currentMatchIndex = (currentMatchIndex - 1 + searchMatches.length) % searchMatches.length; jumpToMatch(); updateSearchInfo(); } }
    function jumpToMatch() { const m = searchMatches[currentMatchIndex]; if (!m) return; inputArea.focus(); inputArea.setSelectionRange(m.start, m.end); scrollToCursorPosition(m.start); updateCursorLineDisplay(); }
    function replaceOne() { if (currentMatchIndex < 0) findNext(); if (currentMatchIndex < 0) return; const r = document.getElementById('replace-input').value, m = searchMatches[currentMatchIndex]; inputArea.setRangeText(r, m.start, m.end, 'select'); doSearch(); jumpToMatch(); }
    function replaceAll() { const q = document.getElementById('search-input').value, r = document.getElementById('replace-input').value; if (!q) return; inputArea.value = inputArea.value.split(q).join(r); updateInputStats(); }

    // Memo Pane with Tabs
    const MEMO_KEY = 'cc_editor_memo_tabs';
    const memoArea = document.getElementById('memo-area');
    const memoCharCount = document.getElementById('memo-char-count');
    let memoTabs = [{ id: 1, name: 'ãƒ¡ãƒ¢1', content: '' }];
    let activeMemoTabId = 1;
    let nextMemoTabId = 2;

    function toggleMemoPane() {
        const p = document.getElementById('memo-panel');
        p.classList.toggle('open');
    }

    function toggleMemoDock() {
        const d = document.getElementById('check-memo-dock').checked;
        const c = document.getElementById('main-container');
        const b = document.getElementById('btn-memo-swap');
        if (d) {
            c.classList.add('memo-docked');
            b.style.display = 'inline-block';
        } else {
            c.classList.remove('memo-docked', 'memo-right');
            b.style.display = 'none';
            document.getElementById('memo-panel').style.width = '280px';
        }
    }

    function swapMemoSide() {
        document.getElementById('main-container').classList.toggle('memo-right');
    }

    function renderMemoTabs() {
        const container = document.getElementById('memo-tabs-container');
        if (!container) return;
        container.innerHTML = '';
        memoTabs.forEach(tab => {
            const tabEl = document.createElement('div');
            tabEl.className = 'memo-tab' + (tab.id === activeMemoTabId ? ' active' : '');
            tabEl.innerHTML = `<span ondblclick="startEditMemoTabName(${tab.id})">${escapeHtml(tab.name)}</span>`;
            if (memoTabs.length > 1) {
                tabEl.innerHTML += `<span style="margin-left:4px;cursor:pointer;font-size:0.65rem;" onclick="event.stopPropagation();deleteMemoTab(${tab.id})">âœ•</span>`;
            }
            tabEl.onclick = () => switchMemoTab(tab.id);
            container.appendChild(tabEl);
        });
        const addBtn = document.createElement('div');
        addBtn.className = 'memo-tab memo-tab-add';
        addBtn.textContent = 'ï¼‹';
        addBtn.onclick = addNewMemoTab;
        container.appendChild(addBtn);
    }

    function switchMemoTab(id) {
        const currentTab = memoTabs.find(t => t.id === activeMemoTabId);
        if (currentTab) currentTab.content = memoArea.value;
        activeMemoTabId = id;
        const newTab = memoTabs.find(t => t.id === id);
        memoArea.value = newTab ? newTab.content : '';
        renderMemoTabs();
        updateMemoCharCount();
        saveMemoTabs();
    }

    function addNewMemoTab() {
        const currentTab = memoTabs.find(t => t.id === activeMemoTabId);
        if (currentTab) currentTab.content = memoArea.value;
        memoTabs.push({ id: nextMemoTabId, name: `ãƒ¡ãƒ¢${nextMemoTabId}`, content: '' });
        activeMemoTabId = nextMemoTabId;
        nextMemoTabId++;
        memoArea.value = '';
        renderMemoTabs();
        updateMemoCharCount();
        saveMemoTabs();
    }

    function deleteMemoTab(id) {
        if (memoTabs.length <= 1) return;
        if (!confirm('ã“ã®ãƒ¡ãƒ¢ã‚¿ãƒ–ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const idx = memoTabs.findIndex(t => t.id === id);
        memoTabs.splice(idx, 1);
        if (activeMemoTabId === id) {
            activeMemoTabId = memoTabs[Math.max(0, idx - 1)].id;
            memoArea.value = memoTabs.find(t => t.id === activeMemoTabId).content;
        }
        renderMemoTabs();
        updateMemoCharCount();
        saveMemoTabs();
    }

    function startEditMemoTabName(id) {
        const tab = memoTabs.find(t => t.id === id);
        const newName = prompt('ã‚¿ãƒ–åã‚’å…¥åŠ›:', tab.name);
        if (newName && newName.trim()) {
            tab.name = newName.trim();
            renderMemoTabs();
            saveMemoTabs();
        }
    }

    function loadMemoTabs() {
        const saved = localStorage.getItem(MEMO_KEY);
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if (data.tabs && data.tabs.length > 0) {
                    memoTabs = data.tabs;
                    activeMemoTabId = data.activeId || memoTabs[0].id;
                    nextMemoTabId = data.nextId || Math.max(...memoTabs.map(t => t.id)) + 1;
                    const activeTab = memoTabs.find(t => t.id === activeMemoTabId);
                    memoArea.value = activeTab ? activeTab.content : '';
                }
            } catch (e) { /* use defaults */ }
        }
        renderMemoTabs();
        updateMemoCharCount();
    }

    function saveMemoTabs() {
        const currentTab = memoTabs.find(t => t.id === activeMemoTabId);
        if (currentTab) currentTab.content = memoArea.value;
        localStorage.setItem(MEMO_KEY, JSON.stringify({
            tabs: memoTabs,
            activeId: activeMemoTabId,
            nextId: nextMemoTabId
        }));
    }

    function updateMemoCharCount() {
        if (!memoArea || !memoCharCount) return;
        const count = memoArea.value.replace(/[\n\r\s]/g, '').length;
        memoCharCount.textContent = `${count}å­—`;
    }

    function showMemoSaveDialog() {
        document.getElementById('memo-save-dialog').style.display = 'flex';
    }
    function closeMemoSaveDialog() {
        document.getElementById('memo-save-dialog').style.display = 'none';
    }
    function executeMemoSave() {
        const scope = document.querySelector('input[name="memo-save-scope"]:checked')?.value || 'current';
        const currentTab = memoTabs.find(t => t.id === activeMemoTabId);
        if (currentTab) currentTab.content = memoArea.value;
        let content;
        if (scope === 'all') {
            content = memoTabs.map(t => `â—‡ ${t.name}\n${t.content}`).join('\n\n');
        } else {
            content = currentTab ? currentTab.content : '';
        }
        const blob = new Blob([content], { type: 'text/plain' });
        const a = document.createElement('a');
        const n = new Date();
        a.href = URL.createObjectURL(blob);
        a.download = `memo_${n.getFullYear()}${(n.getMonth()+1).toString().padStart(2,'0')}${n.getDate().toString().padStart(2,'0')}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        closeMemoSaveDialog();
    }

    function loadMemoFile(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const content = e.target.result;
            // Try to parse tab format (â—‡ TabName\ncontent)
            const parts = content.split(/\nâ—‡ /);
            if (parts.length > 1 || content.startsWith('â—‡ ')) {
                memoTabs = [];
                nextMemoTabId = 1;
                parts.forEach((part, idx) => {
                    if (idx === 0 && !content.startsWith('â—‡ ')) {
                        memoTabs.push({ id: nextMemoTabId++, name: 'ãƒ¡ãƒ¢1', content: part });
                    } else {
                        const cleanPart = idx === 0 ? part.substring(2) : part;
                        const lines = cleanPart.split('\n');
                        const name = lines[0] || `ãƒ¡ãƒ¢${nextMemoTabId}`;
                        const tabContent = lines.slice(1).join('\n');
                        memoTabs.push({ id: nextMemoTabId++, name, content: tabContent });
                    }
                });
                activeMemoTabId = memoTabs[0].id;
                memoArea.value = memoTabs[0].content;
            } else {
                memoArea.value = content;
                const currentTab = memoTabs.find(t => t.id === activeMemoTabId);
                if (currentTab) currentTab.content = content;
            }
            renderMemoTabs();
            updateMemoCharCount();
            saveMemoTabs();
        };
        reader.readAsText(file);
        input.value = '';
    }

    memoArea.addEventListener('input', () => {
        updateMemoCharCount();
        saveMemoTabs();
    });

    let outlineData = [];
    function toggleOutline() { const p = document.getElementById('outline-panel'); if (p.classList.contains('open')) { p.classList.remove('open'); document.getElementById('btn-toggle-outline')?.classList.remove('active'); } else { generateOutline(); p.classList.add('open'); document.getElementById('btn-toggle-outline')?.classList.add('active'); } }
    function toggleOutlineDock() { const d = document.getElementById('check-outline-dock').checked, c = document.getElementById('main-container'), b = document.getElementById('btn-outline-swap'); if (d) { c.classList.add('outline-docked'); b.style.display = 'inline-block'; } else { c.classList.remove('outline-docked', 'outline-left'); b.style.display = 'none'; document.getElementById('outline-panel').style.width = '300px'; } }
    function swapOutlineSide() { document.getElementById('main-container').classList.toggle('outline-left'); }
    function switchOutlineTab(tab) {
        document.querySelectorAll('#outline-panel .outline-tabs-inner .memo-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.outline-tab-content').forEach(c => c.classList.remove('active'));
        const tabEl = document.querySelector(`#outline-panel .outline-tabs-inner .memo-tab[onclick*="${tab}"]`);
        if (tabEl) tabEl.classList.add('active');
        const content = document.getElementById(`outline-tab-${tab}`);
        if (content) content.classList.add('active');
    }

    function generateOutline() {
        const l = document.getElementById('outline-list'), sm = document.getElementById('outline-summary'); l.innerHTML = ''; outlineData = [];
        const t = inputArea.value, ls = t.split('\n'), rx = /^([#ï¼ƒâ– â–¡â–²â–³â–¼â–½â—†â—‡â—‹â—â—Â§ãƒ»â€»â˜†â˜…]+|ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ\d]+[ç« è©±ç¯€éƒ¨ç·¨]|[â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©â‘ªâ‘«â‘¬â‘­â‘®â‘¯â‘°â‘±â‘²â‘³]+|[â… â…¡â…¢â…£â…¤â…¥â…¦â…§â…¨â…©]+)/;
        let cl = 0, lm = new Map(), ca = 0, found = false;
        ls.forEach(line => { const c = line.trim(), cp = ca; ca += line.length + 1; const m = c.match(rx); if (m) { found = true; let sk = m[1]; if (sk.match(/^ç¬¬.+[ç« è©±ç¯€éƒ¨ç·¨]$/)) sk = '___CHAPTER___'; else if (sk.match(/^[â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©â‘ªâ‘«â‘¬â‘­â‘®â‘¯â‘°â‘±â‘²â‘³]+$/)) sk = '___CIRCLED___'; else if (sk.match(/^[â… â…¡â…¢â…£â…¤â…¥â…¦â…§â…¨â…©]+$/)) sk = '___ROMAN___'; if (!lm.has(sk)) { cl++; lm.set(sk, cl); } outlineData.push({ text: c, level: lm.get(sk), pos: cp, length: c.length, collapsed: false, index: outlineData.length, directCharCount: 0, charCount: 0 }); } });
        const tl = t.length; for (let i = 0; i < outlineData.length; i++) { const sp = outlineData[i].pos, ep = (i + 1 < outlineData.length) ? outlineData[i + 1].pos : tl; outlineData[i].directCharCount = t.substring(sp, ep).replace(/[\n\sã€€]/g, '').length; }
        for (let i = outlineData.length - 1; i >= 0; i--) { const clv = outlineData[i].level; let tc = outlineData[i].directCharCount; for (let j = i + 1; j < outlineData.length; j++) { if (outlineData[j].level <= clv) break; if (outlineData[j].level === clv + 1) tc += outlineData[j].charCount; else { let hp = false; for (let k = j - 1; k > i; k--) { if (outlineData[k].level === outlineData[j].level - 1) { hp = true; break; } if (outlineData[k].level <= clv) break; } if (!hp) tc += outlineData[j].charCount; } } outlineData[i].charCount = tc; }
        let lc = new Map(); outlineData.forEach(it => { if (!lc.has(it.level)) lc.set(it.level, 0); lc.set(it.level, lc.get(it.level) + it.directCharCount); });
        if (found) { let st = 'æ–‡å­—æ•°: '; Array.from(lc.keys()).sort((a,b) => a-b).forEach((lv, i, a) => { st += `Lv${lv}: ${lc.get(lv).toLocaleString()}`; if (i < a.length - 1) st += ' / '; }); sm.innerHTML = st; sm.style.display = 'block'; } else { sm.style.display = 'none'; }
        renderOutline(); if (!found) l.innerHTML = '<div class="outline-empty">è¦‹å‡ºã—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>';
    }
    function renderOutline() {
        const l = document.getElementById('outline-list'); l.innerHTML = '';
        outlineData.forEach((it, idx) => {
            const d = document.createElement('div'); d.className = `outline-item outline-level-${Math.min(it.level, 3)}`;
            const hc = outlineData.some((x, i) => i > idx && x.level > it.level && !outlineData.slice(idx + 1, i).some(m => m.level <= it.level));
            const tg = document.createElement('span'); tg.className = 'outline-toggle'; if (hc) { tg.textContent = it.collapsed ? 'â–¶' : 'â–¼'; tg.onclick = e => { e.stopPropagation(); toggleOutlineItem(idx); }; } d.appendChild(tg);
            const ts = document.createElement('span'); ts.className = 'outline-text'; ts.textContent = it.text; d.appendChild(ts);
            const cc = document.createElement('span'); cc.className = 'outline-char-count'; cc.textContent = it.charCount.toLocaleString(); d.appendChild(cc);
            let hd = false; for (let i = 0; i < idx; i++) { if (outlineData[i].collapsed && outlineData[i].level < it.level) { let ir = true; for (let j = i + 1; j < idx; j++) { if (outlineData[j].level <= outlineData[i].level) { ir = false; break; } } if (ir) { hd = true; break; } } } if (hd) d.classList.add('outline-hidden');
            d.onclick = e => { if (e.target.classList.contains('outline-toggle')) return; inputArea.focus(); inputArea.setSelectionRange(it.pos, it.pos + it.length); setTimeout(() => scrollToCursorPosition(it.pos), 100); updateCursorLineDisplay(); if (window.innerWidth < 768 && !document.getElementById('check-outline-dock').checked) toggleOutline(); };
            l.appendChild(d);
        });
    }
    function toggleOutlineItem(i) { outlineData[i].collapsed = !outlineData[i].collapsed; renderOutline(); }
    function expandAllOutline() { outlineData.forEach(it => it.collapsed = false); renderOutline(); }
    function collapseAllOutline() { outlineData.forEach(it => it.collapsed = true); renderOutline(); }

    function toggleLayoutAxis() { const c = document.getElementById('main-container'); if (layoutAxis === 'row') { layoutAxis = 'column'; document.body.classList.add('scroll-mode'); btnSwap.innerText = 'ä¸Šä¸‹å…¥æ›¿'; } else { layoutAxis = 'row'; document.body.classList.remove('scroll-mode'); btnSwap.innerText = 'å·¦å³å…¥æ›¿'; } c.classList.remove('reverse-row', 'reverse-col'); layoutReversed = false; }
    function toggleLayoutOrder() { const c = document.getElementById('main-container'); layoutReversed = !layoutReversed; c.classList.remove('reverse-row', 'reverse-col'); if (layoutReversed) c.classList.add(layoutAxis === 'row' ? 'reverse-row' : 'reverse-col'); }

    function showJumpDialog() { document.getElementById('jump-dialog').classList.add('show'); document.getElementById('jump-line-input').value = ''; document.getElementById('jump-line-input').focus(); }
    function closeJumpDialog() { document.getElementById('jump-dialog').classList.remove('show'); }
    function executeJump() { const ln = parseInt(document.getElementById('jump-line-input').value); if (isNaN(ln) || ln < 1) { alert('æœ‰åŠ¹ãªè¡Œç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; } const ls = inputArea.value.split('\n'); if (ln > ls.length) { alert(`æœ€å¤§è¡Œæ•°ã¯ ${ls.length} è¡Œã§ã™ã€‚`); return; } let p = 0; for (let i = 0; i < ln - 1; i++) p += ls[i].length + 1; inputArea.focus(); inputArea.setSelectionRange(p, p); setTimeout(() => scrollToCursorPosition(p), 100); updateCursorLineDisplay(); closeJumpDialog(); }
    document.getElementById('jump-line-input').addEventListener('keydown', e => { if (e.key === 'Enter') executeJump(); if (e.key === 'Escape') closeJumpDialog(); });

    let currentHeatmapType = 'paragraph';
    function showAnalysis() {
        const t = inputArea.value, tc = t.replace(/[\n\sã€€]/g, '').length;
        const kc = (t.match(/[ä¸€-é¾ ã€…ã€†ãƒµãƒ¶]/g) || []).length, hc = (t.match(/[ã-ã‚“]/g) || []).length, ktc = (t.match(/[ã‚¡-ãƒ´ãƒ¼]/g) || []).length, oc = tc - kc - hc - ktc;
        const kp = tc > 0 ? (kc / tc * 100).toFixed(1) : 0, hp = tc > 0 ? (hc / tc * 100).toFixed(1) : 0, ktp = tc > 0 ? (ktc / tc * 100).toFixed(1) : 0, op = tc > 0 ? (oc / tc * 100).toFixed(1) : 0;
        const ss = t.split(/ã€‚|ï¼|ï¼Ÿ|\!|\?/).filter(s => s.trim().length > 0), sl = ss.map(s => s.replace(/[\n\sã€€]/g, '').length);
        const al = sl.length > 0 ? Math.round(sl.reduce((a, b) => a + b, 0) / sl.length) : 0, ml = sl.length > 0 ? Math.max(...sl) : 0, ls = sl.filter(l => l > 100).length;
        const dm = t.match(/ã€Œ[^ã€]*ã€/g) || [], dc = dm.join('').replace(/[ã€Œã€\n\sã€€]/g, '').length, dp = tc > 0 ? (dc / tc * 100).toFixed(1) : 0, np = (100 - parseFloat(dp)).toFixed(1);
        const ct = t.replace(/[\n\sã€€ã€Œã€ã€ã€ï¼ˆï¼‰()ã€ã€‚ï¼ï¼Ÿ\!\?â€¦â€•â”€]/g, ''), fm = new Map();
        for (let len = 2; len <= 4; len++) { for (let i = 0; i <= ct.length - len; i++) { const w = ct.substring(i, i + len); if (!/^[ã-ã‚“ã‚¡-ãƒ´ãƒ¼ä¸€-é¾ ã€…ã€†ãƒµãƒ¶]+$/.test(w)) continue; fm.set(w, (fm.get(w) || 0) + 1); } }
        const fw = Array.from(fm.entries()).filter(([w, c]) => c >= 3).sort((a, b) => b[1] - a[1]).slice(0, 15);
        document.getElementById('analysis-results').innerHTML = `
            <div class="analysis-section"><h4>ğŸ“Š æ–‡å­—ç¨®åˆ¥</h4>
                <div class="analysis-row"><span>æ¼¢å­—</span><span>${kc.toLocaleString()}å­— (${kp}%)</span></div><div class="analysis-bar"><div class="analysis-bar-fill" style="width:${kp}%; background:#dc2626;"></div></div>
                <div class="analysis-row"><span>ã²ã‚‰ãŒãª</span><span>${hc.toLocaleString()}å­— (${hp}%)</span></div><div class="analysis-bar"><div class="analysis-bar-fill" style="width:${hp}%; background:#2563eb;"></div></div>
                <div class="analysis-row"><span>ã‚«ã‚¿ã‚«ãƒŠ</span><span>${ktc.toLocaleString()}å­— (${ktp}%)</span></div><div class="analysis-bar"><div class="analysis-bar-fill" style="width:${ktp}%; background:#16a34a;"></div></div>
                <div class="analysis-row"><span>ãã®ä»–</span><span>${oc.toLocaleString()}å­— (${op}%)</span></div><div class="analysis-bar"><div class="analysis-bar-fill" style="width:${op}%; background:#9ca3af;"></div></div>
            </div>
            <div class="analysis-section"><h4>ğŸ“ æ–‡é•·åˆ†æ</h4>
                <div class="analysis-row"><span>æ–‡ã®æ•°</span><span>${ss.length}æ–‡</span></div>
                <div class="analysis-row"><span>å¹³å‡æ–‡é•·</span><span>${al}å­—</span></div>
                <div class="analysis-row"><span>æœ€é•·æ–‡</span><span>${ml}å­—</span></div>
                ${ls > 0 ? `<div class="warning-text">âš ï¸ 100å­—è¶…ã®é•·ã„æ–‡ãŒ ${ls} ç®‡æ‰€</div>` : '<div style="color:#16a34a;">âœ“ æ¥µç«¯ã«é•·ã„æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>'}
            </div>
            <div class="analysis-section"><h4>ğŸ’¬ ä¼šè©±æ–‡æ¯”ç‡</h4>
                <div class="analysis-row"><span>ä¼šè©±æ–‡</span><span>${dc.toLocaleString()}å­— (${dp}%)</span></div><div class="analysis-bar"><div class="analysis-bar-fill" style="width:${dp}%; background:#f97316;"></div></div>
                <div class="analysis-row"><span>åœ°ã®æ–‡</span><span>${(tc - dc).toLocaleString()}å­— (${np}%)</span></div><div class="analysis-bar"><div class="analysis-bar-fill" style="width:${np}%; background:#8b5cf6;"></div></div>
            </div>
            <div class="analysis-section"><h4>ğŸ”¤ é »å‡ºèª TOP15</h4>
                ${fw.length > 0 ? `<div class="freq-list">${fw.map(([w, c]) => `<span class="freq-item">${w} (${c})</span>`).join('')}</div>` : '<div class="outline-empty">ååˆ†ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
            </div>
            <div class="analysis-section"><h4>ğŸ—ºï¸ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—åˆ†æ</h4>
                <div class="heatmap-tabs">
                    <span class="heatmap-tab ${currentHeatmapType === 'paragraph' ? 'active' : ''}" onclick="switchHeatmap('paragraph')">æ®µè½é•·</span>
                    <span class="heatmap-tab ${currentHeatmapType === 'kanji' ? 'active' : ''}" onclick="switchHeatmap('kanji')">æ¼¢å­—å¯†åº¦</span>
                    <span class="heatmap-tab ${currentHeatmapType === 'char' ? 'active' : ''}" onclick="switchHeatmap('char')">æ–‡å­—é »åº¦</span>
                    <span class="heatmap-tab ${currentHeatmapType === 'ending' ? 'active' : ''}" onclick="switchHeatmap('ending')">æ–‡æœ«è¡¨ç¾</span>
                    <span class="heatmap-tab ${currentHeatmapType === 'punct' ? 'active' : ''}" onclick="switchHeatmap('punct')">å¥èª­ç‚¹å¯†åº¦</span>
                </div>
                <div id="heatmap-display"></div>
            </div>`;
        renderHeatmap();
        document.getElementById('analysis-modal').classList.add('show');
    }
    function switchHeatmap(type) { currentHeatmapType = type; document.querySelectorAll('.heatmap-tab').forEach(t => t.classList.remove('active')); document.querySelector(`.heatmap-tab[onclick*="${type}"]`).classList.add('active'); renderHeatmap(); }
    function getHeatColor(value, type) {
        const colors = { paragraph: ['#dcfce7','#86efac','#22c55e','#16a34a','#15803d'], kanji: ['#fef3c7','#fcd34d','#f59e0b','#d97706','#b45309'], char: ['#dbeafe','#93c5fd','#3b82f6','#2563eb','#1d4ed8'], ending: ['#fce7f3','#f9a8d4','#ec4899','#db2777','#be185d'], punct: ['#f3e8ff','#c4b5fd','#a78bfa','#8b5cf6','#7c3aed'] };
        const idx = Math.min(4, Math.floor(value * 5)); return colors[type][idx];
    }
    function renderHeatmap() {
        const t = inputArea.value, container = document.getElementById('heatmap-display');
        const paragraphs = t.split(/\n\n+/).filter(p => p.trim().length > 0);
        if (paragraphs.length === 0) { container.innerHTML = '<div class="outline-empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
        let cells = [], legend = '';
        if (currentHeatmapType === 'paragraph') {
            legend = 'çŸ­ã„ â†’ é•·ã„';
            const lengths = paragraphs.map(p => p.replace(/[\n\sã€€]/g, '').length);
            const maxLen = Math.max(...lengths, 1);
            cells = lengths.map((len, i) => ({ value: len / maxLen, tooltip: `æ®µè½${i+1}: ${len}å­—` }));
        } else if (currentHeatmapType === 'kanji') {
            legend = 'å°‘ãªã„ â†’ å¤šã„';
            cells = paragraphs.map((p, i) => { const clean = p.replace(/[\n\sã€€]/g, ''); const kj = (p.match(/[ä¸€-é¾ ã€…ã€†ãƒµãƒ¶]/g) || []).length; const ratio = clean.length > 0 ? kj / clean.length : 0; return { value: ratio, tooltip: `æ®µè½${i+1}: ${(ratio*100).toFixed(1)}%` }; });
        } else if (currentHeatmapType === 'char') {
            legend = 'ä½é »åº¦ â†’ é«˜é »åº¦';
            const allChars = t.replace(/[\n\sã€€ã€Œã€ã€ã€ï¼ˆï¼‰()ã€ã€‚ï¼ï¼Ÿ\!\?â€¦â€•â”€\r]/g, '');
            const charFreq = new Map(); for (const c of allChars) charFreq.set(c, (charFreq.get(c) || 0) + 1);
            const maxFreq = Math.max(...charFreq.values(), 1);
            const blockSize = 50;
            for (let i = 0; i < allChars.length; i += blockSize) {
                const block = allChars.substring(i, i + blockSize);
                let sum = 0; for (const c of block) sum += charFreq.get(c) || 0;
                const avg = sum / block.length / maxFreq;
                cells.push({ value: avg, tooltip: `${i+1}-${Math.min(i+blockSize, allChars.length)}å­—ç›®` });
            }
        } else if (currentHeatmapType === 'ending') {
            legend = 'ã€‚å¤š â†’ å¤šæ§˜';
            const sentences = t.split(/(?<=[ã€‚ï¼ï¼Ÿ\!\?])/).filter(s => s.trim().length > 0);
            const blockSize = 10;
            for (let i = 0; i < sentences.length; i += blockSize) {
                const block = sentences.slice(i, i + blockSize);
                const endings = block.map(s => { const m = s.match(/[ã€‚ï¼ï¼Ÿ\!\?]/); return m ? m[0] : ''; });
                const unique = new Set(endings.filter(e => e)).size;
                const variety = unique / Math.min(block.length, 4);
                cells.push({ value: Math.min(1, variety), tooltip: `æ–‡${i+1}-${i+block.length}: ${unique}ç¨®é¡` });
            }
        } else if (currentHeatmapType === 'punct') {
            legend = 'å°‘ãªã„ â†’ å¤šã„';
            cells = paragraphs.map((p, i) => { const clean = p.replace(/[\n\sã€€]/g, ''); const puncts = (p.match(/[ã€ã€‚ï¼ï¼Ÿ\!\?â€¦â€•â”€ã€Œã€ã€ã€ï¼ˆï¼‰()]/g) || []).length; const ratio = clean.length > 0 ? puncts / clean.length : 0; return { value: Math.min(1, ratio * 5), tooltip: `æ®µè½${i+1}: ${puncts}å€‹` }; });
        }
        container.innerHTML = `<div class="heatmap-title"><span>${{paragraph:'æ®µè½é•·ã•',kanji:'æ¼¢å­—å¯†åº¦',char:'æ–‡å­—é »åº¦',ending:'æ–‡æœ«è¡¨ç¾',punct:'å¥èª­ç‚¹å¯†åº¦'}[currentHeatmapType]}</span><span class="heatmap-legend">${legend}</span></div><div class="heatmap-grid">${cells.map(c => `<div class="heatmap-cell" style="background:${getHeatColor(c.value, currentHeatmapType)}" data-tooltip="${c.tooltip}"></div>`).join('')}</div>`;
    }
    function closeAnalysis() { document.getElementById('analysis-modal').classList.remove('show'); }

    function showSaveDialog() { document.getElementById('save-dialog-overlay').style.display = 'flex'; }
    function closeSaveDialog() { document.getElementById('save-dialog-overlay').style.display = 'none'; }
    function getSaveScope() { return document.querySelector('input[name="save-scope"]:checked')?.value || 'current'; }
    function getContentToSave() { return getSaveScope() === 'all' ? getAllTabsContent() : getCurrentTabContent(); }
    function saveAsText() { const content = getContentToSave(); const b = new Blob([content], { type: 'text/plain' }), a = document.createElement('a'), n = new Date(); a.href = URL.createObjectURL(b); a.download = `novel_${n.getFullYear()}${(n.getMonth()+1).toString().padStart(2,'0')}${n.getDate().toString().padStart(2,'0')}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); closeSaveDialog(); }
    function saveAsHTML() {
        const scope = getSaveScope();
        const v = document.getElementById('st-pv-v').checked, fk = document.getElementById('st-pv-font').value, fs = document.getElementById('st-pv-size').value, lh = document.getElementById('st-pv-line').value;
        let htmlContent = '';
        if (scope === 'all') {
            const currentTab = inputTabs.find(t => t.id === activeTabId);
            if (currentTab) currentTab.content = inputArea.value;
            inputTabs.forEach((tab, idx) => {
                if (idx > 0) htmlContent += '<div style="page-break-before: always; margin-top: 40px;"></div>';
                htmlContent += `<h2 style="font-size: 1.5em; margin-bottom: 1em;">${escapeHtml(tab.name)}</h2>`;
                htmlContent += renderTextToHTML(tab.content);
            });
        } else {
            updatePreview();
            htmlContent = previewContent.innerHTML;
        }
        const h = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</title><link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho&family=Noto+Sans+JP&display=swap" rel="stylesheet"><style>body{margin:40px;background:#fdfcf0;font-family:${fontMap[fk]};font-size:${fs}px;line-height:${lh};${v?'writing-mode:vertical-rl;min-height:100vh;':''}}ruby{ruby-align:space-between;}rt{font-size:0.5em;color:#555;}.bouten-ruby rt{font-size:0.8em;font-weight:bold;}.underline-text{text-decoration:underline;text-decoration-color:#dc2626;}.highlight-text{background:linear-gradient(transparent 60%,#fef08a 60%);}</style></head><body>${htmlContent}</body></html>`;
        const b = new Blob([h], { type: 'text/html' }), a = document.createElement('a'), n = new Date();
        a.href = URL.createObjectURL(b); a.download = `novel_${n.getFullYear()}${(n.getMonth()+1).toString().padStart(2,'0')}${n.getDate().toString().padStart(2,'0')}.html`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); closeSaveDialog();
    }
    function renderTextToHTML(text) {
        const ss = settingsCache.showSpace, sh = settingsCache.showHighlight;
        let s = escapeHtml(text);
        const MZ = '\uE001', MH = '\uE002'; if (ss) { s = s.replace(/ã€€/g, MZ).replace(/ /g, MH); }
        if (sh) { s = s.replace(/ã€Œ(.*?)ã€/g, '<span class="bracket-blue">ã€Œ$1ã€</span>').replace(/ã€(.*?)ã€/g, '<span class="bracket-green">ã€$1ã€</span>'); }
        s = s.replace(/ï½œ([^ã€Š]+?)ã€Š(.+?)ã€‹/g, '<ruby>$1<rt>$2</rt></ruby>').replace(/([ä¸€-é¾ ã€…ã€†ãƒµãƒ¶]+)ã€Š(.+?)ã€‹/g, '<ruby>$1<rt>$2</rt></ruby>');
        s = s.replace(/ã€Šã€Š(.+?)ã€‹ã€‹/g, (m, p) => { let r = ''; for (let c of p) r += `<ruby class="bouten-ruby">${c}<rt>ãƒ»</rt></ruby>`; return r; });
        s = s.replace(/__(.+?)__/g, '<span class="underline-text">$1</span>').replace(/==(.+?)==/g, '<span class="highlight-text">$1</span>');
        if (sh) s = s.replace(/([â€•â”€]{2,}|â€¦{2,})/g, '<span class="symbol-hl">$1</span>');
        if (ss) { s = s.split(MZ).join('<span class="space-zen">â–¡</span>').split(MH).join('<span class="space-han">ï½¥</span>'); }
        return s.replace(/\n/g, '<br>');
    }
    function loadFile(input) {
        const f = input.files[0]; if (!f) return;
        const r = new FileReader();
        r.onload = e => {
            inputArea.value = e.target.result;
            const currentTab = inputTabs.find(t => t.id === activeTabId);
            if (currentTab) currentTab.content = e.target.result;
            updateInputStats();
            updatePreview();
            saveTabsToStorage();
            input.value = '';
        };
        r.readAsText(f);
    }

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') { if (document.body.classList.contains('focus-mode')) toggleFocusMode(); closeJumpDialog(); closeAnalysis(); closeMemoSaveDialog(); }
        if (e.key === 'F11') { e.preventDefault(); toggleFocusMode(); }
        if (e.ctrlKey && e.key === 'g') { e.preventDefault(); showJumpDialog(); }
        if (e.ctrlKey && e.key === 'f') { e.preventDefault(); togglePanel('search-bar'); }
        if (e.ctrlKey && e.key === 's') { e.preventDefault(); showSaveDialog(); }
        if (e.ctrlKey && !e.shiftKey && e.key === 't') { e.preventDefault(); addNewTab(); }
        if (e.ctrlKey && e.shiftKey && e.key === 'T') { e.preventDefault(); addNewMemoTab(); }
    });
    inputArea.addEventListener('keyup', updateCursorLineDisplay);
    inputArea.addEventListener('click', updateCursorLineDisplay);

    // Pane Resizer
    (function initResizer() {
        const resizer = document.getElementById('resizer-input-preview');
        const inputPane = document.getElementById('pane-input');
        const previewPane = document.getElementById('pane-preview');
        const mainContainer = document.getElementById('main-container');
        let isResizing = false;

        resizer.addEventListener('mousedown', e => {
            isResizing = true;
            resizer.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', e => {
            if (!isResizing) return;
            const containerRect = mainContainer.getBoundingClientRect();
            const mouseX = e.clientX - containerRect.left;
            const ratio = Math.max(0.1, Math.min(0.9, mouseX / containerRect.width));

            if (mainContainer.classList.contains('reverse-row')) {
                previewPane.style.flex = `0 0 ${ratio * 100}%`;
                inputPane.style.flex = `0 0 ${(1 - ratio) * 100}%`;
            } else {
                inputPane.style.flex = `0 0 ${ratio * 100}%`;
                previewPane.style.flex = `0 0 ${(1 - ratio) * 100}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                // Save pane widths to settings and localStorage
                const containerRect = mainContainer.getBoundingClientRect();
                const inputRect = inputPane.getBoundingClientRect();
                const previewRect = previewPane.getBoundingClientRect();
                const inputWidth = Math.round((inputRect.width / containerRect.width) * 100);
                const previewWidth = Math.round((previewRect.width / containerRect.width) * 100);
                document.getElementById('st-pane-input-width').value = inputWidth;
                document.getElementById('st-pane-preview-width').value = previewWidth;
                localStorage.setItem('cc_pane_input_width', inputWidth);
                localStorage.setItem('cc_pane_preview_width', previewWidth);
            }
        });
    })();

    // åˆæœŸåŒ–
    loadAutoSave();
    loadTodayStart();
    loadWritingTime();
    loadBookmarks();
    loadMemoTabs();
    loadSettingsFromStorage();
    loadPaneWidthSettings();
    startWritingTimer();
    applyAllSettings();
    // Apply default preview hidden setting on first load
    if (settingsCache.defaultPreviewHidden && !localStorage.getItem('cc_editor_session_started')) {
        document.getElementById('check-show-preview').checked = false;
        document.getElementById('pane-preview').classList.add('hidden');
    }
    sessionStorage.setItem('cc_editor_session_started', 'true');
    updateInputStats();
    renderPreviewTabs();
    updatePreview();
    updateWritingTimeDisplay();
</script>
</body>
</html>
